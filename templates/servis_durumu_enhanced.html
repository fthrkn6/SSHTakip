{% extends "base.html" %}

{% block title %}Servis Durumu - Geli≈ümi≈ü Analytics{% endblock %}

{% block content %}
<style>
    /* Sticky Export Button */
    .sticky-export-panel {
        position: fixed !important;
        left: 0 !important;
        bottom: 20px !important;
        width: auto !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        padding: 15px 20px !important;
        border-radius: 0 50px 50px 0 !important;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
        z-index: 99999 !important;
        animation: slideIn 0.5s ease-out !important;
        display: block !important;
        visibility: visible !important;
    }

    @keyframes slideIn {
        from {
            transform: translateX(-100%);
        }

        to {
            transform: translateX(0);
        }
    }

    .export-btn-group {
        display: flex;
        gap: 10px;
        flex-direction: column;
    }

    .export-btn {
        padding: 10px 15px;
        background: white;
        color: #667eea;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
        white-space: nowrap;
        font-size: 12px;
    }

    .export-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .export-btn-report {
        background: #4CAF50;
        color: white;
    }

    .export-btn-rootcause {
        background: #FF9800;
        color: white;
    }

    .export-btn-daily {
        background: #2196F3;
        color: white;
    }

    /* Dashboard */
    .dashboard-container {
        background: #f5f5f5;
        padding: 20px;
        border-radius: 10px;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 3px solid #667eea;
    }

    .dashboard-header h1 {
        color: #333;
        margin: 0;
        font-size: 28px;
    }

    .filters-bar {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .filter-group label {
        font-weight: bold;
        color: #555;
        font-size: 12px;
        text-transform: uppercase;
    }

    .filter-group select,
    .filter-group input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
    }

    /* Status Table */
    .status-table-wrapper {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }

    .status-table {
        width: 100%;
        border-collapse: collapse;
    }

    .status-table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .status-table th {
        padding: 15px;
        text-align: left;
        font-weight: bold;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-table tbody tr {
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s;
    }

    .status-table tbody tr:hover {
        background: #f9f9f9;
    }

    .status-table td {
        padding: 12px 15px;
        font-size: 13px;
    }

    /* Status Badge */
    .status-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: bold;
        text-transform: uppercase;
    }

    .status-operational {
        background: #4CAF50;
        color: white;
    }

    .status-maintenance {
        background: #FF9800;
        color: white;
    }

    .status-outofservice {
        background: #f44336;
        color: white;
    }

    .status-unknown {
        background: #999;
        color: white;
    }

    /* Availability Percentage */
    .availability-cell {
        font-weight: bold;
    }

    .availability-high {
        color: #4CAF50;
    }

    .availability-medium {
        color: #FF9800;
    }

    .availability-low {
        color: #f44336;
    }

    /* Analytics Cards */
    .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .analytics-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #667eea;
    }

    .analytics-card h3 {
        color: #667eea;
        margin: 0 0 10px 0;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .analytics-card .value {
        font-size: 32px;
        font-weight: bold;
        color: #333;
    }

    .analytics-card .unit {
        font-size: 12px;
        color: #999;
        margin-left: 5px;
    }

    .analytics-card .description {
        font-size: 12px;
        color: #666;
        margin-top: 10px;
    }

    /* Charts */
    .chart-container {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }

    .chart-container h3 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
    }

    /* Root Cause Section */
    .root-cause-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }

    .root-cause-section h3 {
        color: #333;
        margin-top: 0;
        border-bottom: 2px solid #FF9800;
        padding-bottom: 10px;
    }

    .root-cause-item {
        padding: 10px;
        margin: 10px 0;
        border-left: 4px solid #FF9800;
        background: #fff9e6;
        border-radius: 4px;
    }

    .root-cause-item .system {
        font-weight: bold;
        color: #333;
    }

    .root-cause-item .cause {
        color: #666;
        margin-top: 5px;
        font-size: 13px;
    }

    /* Log History */
    .log-history {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        max-height: 400px;
        overflow-y: auto;
    }

    .log-history h3 {
        margin-top: 0;
        color: #333;
    }

    .log-entry {
        padding: 10px;
        margin: 10px 0;
        border-left: 4px solid #2196F3;
        background: #e3f2fd;
        border-radius: 4px;
        font-size: 12px;
    }

    .log-entry .timestamp {
        font-weight: bold;
        color: #2196F3;
    }

    .log-entry .status-change {
        color: #666;
        margin-top: 5px;
    }

    /* Period Buttons */
    .period-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }

    .period-btn {
        padding: 8px 16px;
        background: #f0f0f0;
        border: 2px solid #ddd;
        border-radius: 20px;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        transition: all 0.3s;
    }

    .period-btn:hover,
    .period-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 20px;
        border-radius: 10px;
        width: 80%;
        max-width: 600px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
    }

    .close-btn {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close-btn:hover {
        color: #000;
    }

    /* Loading Spinner */
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .analytics-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .status-table {
            font-size: 12px;
        }
    }

    @media (max-width: 768px) {
        .analytics-grid {
            grid-template-columns: 1fr;
        }

        .dashboard-header {
            flex-direction: column;
            text-align: center;
        }

        .filters-bar {
            grid-template-columns: 1fr;
        }

        .sticky-export-panel {
            left: auto;
            right: 10px;
            padding: 10px;
        }

        .export-btn-group {
            flex-direction: row;
            gap: 5px;
        }

        .export-btn {
            padding: 8px 10px;
            font-size: 11px;
        }
    }
</style>

<!-- Sticky Export Panel (Block dƒ±≈üƒ±nda) -->
<div class="sticky-export-panel">
    <div class="export-btn-group">
        <button class="export-btn export-btn-report" onclick="exportComprehensiveReport()" title="Kapsamlƒ± Rapor">
            üìä Rapor
        </button>
        <button class="export-btn export-btn-rootcause" onclick="exportRootCauseReport()" title="Root Cause Analizi">
            üîç RCA
        </button>
        <button class="export-btn export-btn-daily" onclick="exportDailyReport()" title="G√ºnl√ºk Durum">
            üìÖ G√ºnl√ºk
        </button>
    </div>
</div>

<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div>
            <h1>üöä Servis Durumu & Availability Analizi</h1>
            <p style="color: #999; margin: 5px 0 0 0;">Ara√ßlarƒ±n servis durumlarƒ±nƒ± ger√ßek zamanlƒ± izleyin ve analiz
                edin</p>
        </div>
        <div style="text-align: right;">
            <p style="margin: 0; color: #999;">
                <strong>G√ºncelleme:</strong> <span id="updateTime">{{ current_date.strftime('%d.%m.%Y %H:%M') }}</span>
            </p>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-bar">
        <div class="filter-group">
            <label>Ara√ß Se√ß</label>
            <select id="tramFilter" onchange="filterByTram()">
                <option value="">T√ºm√º</option>
                {% for tram_id in tram_ids %}
                <option value="{{ tram_id }}">{{ tram_id }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label>Durum</label>
            <select id="statusFilter" onchange="filterByStatus()">
                <option value="">T√ºm√º</option>
                <option value="operasyonel">Operasyonel</option>
                <option value="bakƒ±mda">Bakƒ±mda</option>
                <option value="servis_dƒ±≈üƒ±">Servis Dƒ±≈üƒ±</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Sistem</label>
            <select id="systemFilter" onchange="filterBySystem()">
                <option value="">T√ºm√º</option>
                <option value="elektrik">Elektrik</option>
                <option value="mekanik">Mekanik</option>
                <option value="hvac">HVAC</option>
                <option value="seramik">Seramik</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Tarih Aralƒ±ƒüƒ±</label>
            <input type="date" id="dateStart" onchange="filterByDate()">
        </div>

        <div class="filter-group">
            <label>&nbsp;</label>
            <button onclick="refreshTable()"
                style="padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                üîÑ Yenile
            </button>
        </div>
    </div>

    <!-- Analytics Cards -->
    <div class="analytics-grid">
        <div class="analytics-card">
            <h3>Toplam Ara√ß</h3>
            <div class="value" id="totalVehicles">{{ tram_ids|length }}</div>
            <div class="description">Sistemde kayƒ±tlƒ± ara√ß sayƒ±sƒ±</div>
        </div>

        <div class="analytics-card">
            <h3>Operasyonel</h3>
            <div class="value" id="operationalCount">0</div>
            <div class="description">≈ûu an √ßalƒ±≈ümakta olan ara√ßlar</div>
        </div>

        <div class="analytics-card">
            <h3>Bakƒ±m/Servis</h3>
            <div class="value" id="maintenanceCount">0</div>
            <div class="description">Bakƒ±m yapƒ±lmakta olan ara√ßlar</div>
        </div>

        <div class="analytics-card">
            <h3>Ort. Availability</h3>
            <div class="value" id="avgAvailability">0<span class="unit">%</span></div>
            <div class="description">Ortalama kullanƒ±labilirlik oranƒ±</div>
        </div>
    </div>

    <!-- Status Table -->
    <div class="status-table-wrapper">
        <table class="status-table">
            <thead>
                <tr>
                    <th>Ara√ß ID</th>
                    <th>Ara√ß Adƒ±</th>
                    <th>Durum</th>
                    <th>Sistem</th>
                    <th>Alt Sistem</th>
                    <th>Son Deƒüi≈üim</th>
                    <th>Availability</th>
                    <th>Downtime (Saat)</th>
                    <th>ƒ∞≈ülem</th>
                </tr>
            </thead>
            <tbody id="statusTableBody">
                {% if equipment_list %}
                {% for eq in equipment_list %}
                <tr data-vehicle="{{ eq.equipment_code }}">
                    <td><strong>{{ eq.equipment_code }}</strong></td>
                    <td>{{ eq.name }}</td>
                    <td>
                        <span class="badge bg-{{ eq.status_color }}">{{ eq.status_badge }}</span>
                    </td>
                    <td>{{ eq.latest_log.sistem if eq.latest_log else '-' }}</td>
                    <td>{{ eq.latest_log.alt_sistem if eq.latest_log else '-' }}</td>
                    <td>{{ eq.latest_log.log_date.strftime('%d.%m.%Y %H:%M') if eq.latest_log else '-' }}</td>
                    <td><strong>{{ "%.1f"|format(eq.availability) }}%</strong></td>
                    <td>{{ "%.1f"|format(eq.downtime) }} saat</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewDetails('{{ eq.equipment_code }}')">
                            <i class="bi bi-eye"></i> Detay
                        </button>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="9" style="text-align: center; padding: 40px;">
                        <p>Veri bulunamadƒ±</p>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Period Analysis -->
    <div class="chart-container">
        <h3>üìà D√∂nem Analizi</h3>
        <div class="period-buttons">
            <button class="period-btn active" onclick="loadPeriodData('daily')">G√ºnl√ºk</button>
            <button class="period-btn" onclick="loadPeriodData('weekly')">Haftalƒ±k</button>
            <button class="period-btn" onclick="loadPeriodData('monthly')">Aylƒ±k</button>
            <button class="period-btn" onclick="loadPeriodData('quarterly')">3 Aylƒ±k</button>
            <button class="period-btn" onclick="loadPeriodData('biannual')">6 Aylƒ±k</button>
            <button class="period-btn" onclick="loadPeriodData('yearly')">Yƒ±llƒ±k</button>
            <button class="period-btn" onclick="loadPeriodData('total')">Total</button>
        </div>
        <div id="periodChart" style="height: 300px; border: 1px solid #ddd; border-radius: 5px; padding: 10px;">
            Grafik y√ºkleniyor...
        </div>
    </div>

    <!-- Root Cause Analysis -->
    <div class="root-cause-section">
        <h3>üîç Root Cause Analiz √ñzeti (Son 30 G√ºn)</h3>
        <div id="rootCauseContent" style="min-height: 100px;">
            <div class="spinner"></div>
        </div>
    </div>

    <!-- Recent Logs -->
    <div class="log-history">
        <h3>üìã Son Durum Deƒüi≈üiklikleri</h3>
        <div id="logHistory">
            {% for log in recent_logs %}
            <div class="log-entry">
                <div class="timestamp">{{ log.log_date.strftime('%d.%m.%Y %H:%M') }}</div>
                <div class="status-change">
                    <strong>{{ log.tram_id }}</strong>:
                    <span style="color: #999;">{{ log.previous_status }}</span> ‚Üí
                    <span style="color: #333; font-weight: bold;">{{ log.new_status }}</span>
                    {% if log.sistem %}<br>Sistem: {{ log.sistem }}{% endif %}
                    {% if log.alt_sistem %} | Alt Sistem: {{ log.alt_sistem }}{% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Modal -->
<div id="detailModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeDetailModal()">&times;</span>
        <h2>Ara√ß Detaylarƒ±</h2>
        <div id="modalContent" style="max-height: 400px; overflow-y: auto;"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let statusChart = null;

    // Masa yenile
    function refreshTable() {
        fetch('/servis/durumu/tablo')
            .then(response => response.json())
            .then(data => {
                let html = '';
                let operational = 0;
                let maintenance = 0;
                let totalAvailability = 0;

                data.forEach(item => {
                    const statusClass = item.status === 'operasyonel' ? 'operational' :
                        item.status === 'bakƒ±mda' ? 'maintenance' :
                            item.status === 'servis_dƒ±≈üƒ±' ? 'outofservice' : 'unknown';

                    const availabilityClass = item.availability >= 95 ? 'availability-high' :
                        item.availability >= 80 ? 'availability-medium' : 'availability-low';

                    if (item.status === 'operasyonel') operational++;
                    if (item.status === 'bakƒ±mda') maintenance++;

                    totalAvailability += item.availability;

                    html += `
                        <tr>
                            <td><strong>${item.tram_id}</strong></td>
                            <td>${item.name}</td>
                            <td>
                                <span class="status-badge status-${statusClass}">
                                    ${item.status}
                                </span>
                            </td>
                            <td>${item.sistem}</td>
                            <td>${item.alt_sistem}</td>
                            <td>${item.last_status_change}</td>
                            <td>
                                <span class="availability-cell ${availabilityClass}">
                                    ${item.availability.toFixed(2)}%
                                </span>
                            </td>
                            <td>${item.downtime.toFixed(2)}</td>
                            <td>
                                <button onclick="viewDetails('${item.tram_id}')" style="padding: 5px 10px; background: #2196F3; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                    Detay
                                </button>
                            </td>
                        </tr>
                    `;
                });

                document.getElementById('statusTableBody').innerHTML = html || '<tr><td colspan="9" style="text-align: center; padding: 20px;">Veri bulunamadƒ±</td></tr>';

                // Update analytics
                document.getElementById('operationalCount').textContent = operational;
                document.getElementById('maintenanceCount').textContent = maintenance;
                document.getElementById('avgAvailability').textContent =
                    data.length > 0 ? (totalAvailability / data.length).toFixed(1) : 0;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('statusTableBody').innerHTML =
                    '<tr><td colspan="9" style="text-align: center; padding: 20px; color: red;">Hata: Veri y√ºklenemedi</td></tr>';
            });
    }

    // Detay g√∂r√ºnt√ºle
    function viewDetails(tramId) {
        fetch(`/servis/api/root-cause-summary/${tramId}`)
            .then(response => response.json())
            .then(data => {
                let html = '<h4>Sistem Bazƒ±nda K√∂k Nedenler:</h4>';

                for (const [system, details] of Object.entries(data.by_system || {})) {
                    html += `
                        <div style="margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                            <strong>${system}</strong> (${details.count} analiz)
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    `;

                    if (details.subsystems) {
                        for (const [subsystem, count] of Object.entries(details.subsystems)) {
                            html += `<div>‚îî ${subsystem}: ${count}</div>`;
                        }
                    }

                    html += '</div></div>';
                }

                document.getElementById('modalContent').innerHTML = html;
                document.getElementById('detailModal').style.display = 'block';
            });
    }

    function closeDetailModal() {
        document.getElementById('detailModal').style.display = 'none';
    }

    // D√∂nem verisi y√ºkle
    function loadPeriodData(period) {
        // Button active state
        document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        let html = '<div style="text-align: center; padding: 40px;">Veriler y√ºkleniyor...</div>';
        document.getElementById('periodChart').innerHTML = html;
    }

    // Export fonksiyonlarƒ±
    function exportComprehensiveReport() {
        console.log('üìä Kapsamlƒ± rapor indiriliyor...');
        try {
            window.location.href = '/servis/excel/comprehensive-report';
        } catch (e) {
            console.error('Hata:', e);
            alert('Hata: ' + e.message);
        }
    }

    function exportRootCauseReport() {
        console.log('üîç Root Cause raporu indiriliyor...');
        try {
            window.location.href = '/servis/excel/root-cause-report';
        } catch (e) {
            console.error('Hata:', e);
            alert('Hata: ' + e.message);
        }
    }

    function exportDailyReport() {
        const tramId = document.getElementById('tramFilter').value;
        console.log('üìÖ G√ºnl√ºk rapor se√ßimi:', tramId);
        if (!tramId) {
            alert('L√ºtfen bir ara√ß se√ßiniz');
            return;
        }
        try {
            window.location.href = `/servis/excel/daily-report/${tramId}`;
        } catch (e) {
            console.error('Hata:', e);
            alert('Hata: ' + e.message);
        }
    }

    // Filter fonksiyonlarƒ±
    function filterByTram() {
        refreshTable();
    }

    function filterByStatus() {
        refreshTable();
    }

    function filterBySystem() {
        refreshTable();
    }

    function filterByDate() {
        refreshTable();
    }

    // Root Cause √ñzeti Y√ºkle
    function loadRootCauseSummary() {
        fetch('/servis/api/root-cause-summary/all')
            .then(response => response.json())
            .catch(error => console.log('Root cause summary i√ßin √∂zel endpoint gerekli'));
    }

    // Sayfa y√ºklendiƒüinde
    document.addEventListener('DOMContentLoaded', function () {
        refreshTable();
        loadRootCauseSummary();

        // 30 saniyede bir yenile
        setInterval(refreshTable, 30000);
    });

    // Modal dƒ±≈üƒ±na tƒ±klandƒ±ƒüƒ±nda kapat
    window.onclick = function (event) {
        const modal = document.getElementById('detailModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
</script>
{% endblock %}