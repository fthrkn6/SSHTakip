{% extends 'base.html' %}

{% block title %}Yeni Arƒ±za Bildir{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary: #4f46e5;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #06b6d4;
    }

    .page-header {
        background: linear-gradient(135deg, var(--primary) 0%, #7c3aed 100%);
        color: white;
        padding: 1.2rem 1.5rem;
        border-radius: 20px;
        margin-bottom: 1.5rem;
        box-shadow: 0 15px 50px rgba(79, 70, 229, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .page-header h2 {
        margin: 0;
        font-weight: 800;
        font-size: 1.8rem;
        letter-spacing: -0.5px;
    }

    .page-header p {
        font-size: 0.9rem;
        margin-top: 0.3rem !important;
        opacity: 0.95;
        font-weight: 500;
    }

    .page-header .badge {
        background: rgba(255, 255, 255, 0.25);
        padding: 12px 24px;
        border-radius: 50px;
        font-size: 0.95rem;
        font-weight: 700;
        letter-spacing: 0.5px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .page-header .badge i {
        margin-right: 0.5rem;
    }

    .form-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        margin-bottom: 1rem;
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }

    .form-card:hover {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        transform: translateY(-2px);
    }

    .form-card-header {
        padding: 0.8rem 1rem;
        font-weight: 700;
        color: white;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.95rem;
        letter-spacing: 0.3px;
        background-size: 100% 100%;
    }

    .form-card-header i {
        font-size: 1.1rem;
        opacity: 0.95;
    }

    .form-card-body {
        padding: 1rem;
    }

    .bg-vehicle {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .bg-time {
        background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
        box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .bg-system {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .bg-fault {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .bg-action {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .bg-repair {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .bg-part {
        background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
        box-shadow: 0 4px 15px rgba(236, 72, 153, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .form-label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 4px;
        font-size: 0.8rem;
    }

    .form-control,
    .form-select {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 8px 10px;
        font-size: 0.9rem;
        transition: all 0.2s;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .form-control.readonly-field {
        background: #f3f4f6;
        color: #6b7280;
    }

    .required-mark {
        color: var(--danger);
    }

    .autocomplete-wrapper {
        position: relative;
    }

    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid var(--primary);
        border-radius: 10px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }

    .autocomplete-dropdown.show {
        display: block;
    }

    .autocomplete-item {
        padding: 10px 14px;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
        transition: background 0.2s;
    }

    .autocomplete-item:hover {
        background: #f0f9ff;
        color: var(--primary);
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .btn-submit {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border: none;
        color: white;
        padding: 12px 35px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 0.95rem;
        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
        transition: all 0.3s ease;
        cursor: pointer;
        letter-spacing: 0.5px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-submit:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(16, 185, 129, 0.5);
        color: white;
    }

    .btn-submit:active {
        transform: translateY(-1px);
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
    }

    .btn-back {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        border: none;
        color: white;
        padding: 12px 30px;
        border-radius: 50px;
        font-weight: 700;
        text-decoration: none;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        letter-spacing: 0.5px;
        font-size: 0.95rem;
    }

    .btn-back:hover {
        background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .btn-back:active {
        transform: translateY(0);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-2">
    <!-- Header -->
    <div class="page-header d-flex justify-content-between align-items-center flex-wrap">
        <div>
            <h2><i class="fas fa-plus-circle me-2"></i>Yeni Arƒ±za Bildir</h2>
            <p class="mb-0 mt-2 opacity-75">FRACAS sistemine yeni arƒ±za kaydƒ± ekleyin</p>
        </div>
        <span class="badge mt-2">
            <i class="fas fa-map-marker-alt me-1"></i>
            {{ project_name | upper }}
        </span>
    </div>

    <form method="POST" enctype="multipart/form-data">
        <div class="row">
            <!-- Sol Kolon -->
            <div class="col-lg-6">
                <!-- Ara√ß Bilgileri -->
                <div class="form-card">
                    <div class="form-card-header bg-vehicle">
                        <i class="fas fa-subway"></i>
                        Ara√ß Bilgileri
                    </div>
                    <div class="form-card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">FRACAS ID</label>
                                <input type="text" class="form-control readonly-field" name="fracas_id"
                                    value="{{ next_fracas_id }}" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ara√ß No <span class="required-mark">*</span></label>
                                <select class="form-select" name="arac_numarasi" required>
                                    <option value="">-- Ara√ß Se√ßin --</option>
                                    {% for tram in tramvaylar %}
                                    <option value="{{ tram }}">{{ tram }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ara√ß Mod√ºl</label>
                                <select class="form-select" name="arac_module">
                                    <option value="">-- Mod√ºl Se√ßin --</option>
                                    {% for mod in modules %}
                                    <option value="{{ mod }}">{{ mod }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Kilometre</label>
                                <input type="number" class="form-control" name="arac_km" placeholder="Ara√ß km">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hata Zamanƒ± -->
                <div class="form-card">
                    <div class="form-card-header bg-time">
                        <i class="fas fa-clock"></i>
                        Hata Zamanƒ±
                    </div>
                    <div class="form-card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tarih <span class="required-mark">*</span></label>
                                <input type="date" class="form-control" name="hata_tarih" value="{{ today }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Saat <span class="required-mark">*</span></label>
                                <input type="time" class="form-control" name="hata_saat" required>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sistem Bilgileri -->
                <div class="form-card">
                    <div class="form-card-header bg-system">
                        <i class="fas fa-cogs"></i>
                        Sistem Bilgileri
                    </div>
                    <div class="form-card-body">
                        <div class="mb-3">
                            <label class="form-label">Sistem <span class="required-mark">*</span></label>
                            <select class="form-select" id="sistemSelect" name="sistem" required>
                                <option value="">-- Sistem Se√ßin --</option>
                                {% for sistem_adi in sistemler %}
                                <option value="{{ sistem_adi }}">{{ sistem_adi }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Alt Sistem</label>
                                <select class="form-select" id="altSistemSelect" name="alt_sistem">
                                    <option value="">-- √ñnce Sistem Se√ßin --</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tedarik√ßi</label>
                                <select class="form-select" id="tedarikciSelect" name="tedarikci">
                                    <option value="">-- Se√ßin --</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tamir Zamanlarƒ± -->
                <div class="form-card">
                    <div class="form-card-header bg-repair">
                        <i class="fas fa-tools"></i>
                        Tamir Zamanlarƒ±
                    </div>
                    <div class="form-card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ba≈ülama Tarihi</label>
                                <input type="date" class="form-control" name="tamir_baslama_tarih" id="tamirBasTarih">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ba≈ülama Saati</label>
                                <input type="time" class="form-control" name="tamir_baslama_saati" id="tamirBasSaat">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Biti≈ü Tarihi</label>
                                <input type="date" class="form-control" name="tamir_bitisi_tarih" id="tamirBitTarih">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Biti≈ü Saati</label>
                                <input type="time" class="form-control" name="tamir_bitisi_saati" id="tamirBitSaat">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tamir S√ºresi</label>
                                <input type="text" class="form-control readonly-field" name="tamir_suresi"
                                    id="tamirSuresi" readonly placeholder="Otomatik hesaplanƒ±r">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">MTTR (dk)</label>
                                <input type="text" class="form-control readonly-field" name="mttr" id="mttr" readonly
                                    placeholder="Dakika cinsinden">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Personel Sayƒ±sƒ±</label>
                                <input type="number" class="form-control" name="personel_sayisi" min="1" value="1">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Saƒü Kolon -->
            <div class="col-lg-6">
                <!-- Arƒ±za Detaylarƒ± -->
                <div class="form-card">
                    <div class="form-card-header bg-fault">
                        <i class="fas fa-exclamation-triangle"></i>
                        Arƒ±za Detaylarƒ±
                    </div>
                    <div class="form-card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Arƒ±za Sƒ±nƒ±fƒ± <span class="required-mark">*</span></label>
                                <select class="form-select" name="ariza_sinifi" required>
                                    <option value="">-- Se√ßin --</option>
                                    {% for sinif in ariza_siniflari %}
                                    <option value="{{ sinif }}">{{ sinif }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Arƒ±za Kaynaƒüƒ±</label>
                                <select class="form-select" name="ariza_kaynagi">
                                    <option value="">-- Se√ßin --</option>
                                    {% for kaynak in ariza_kaynaklari %}
                                    <option value="{{ kaynak }}">{{ kaynak }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Arƒ±za Tipi</label>
                                <select class="form-select" name="ariza_tipi">
                                    <option value="">-- Se√ßin --</option>
                                    {% for tip in ariza_tipleri %}
                                    <option value="{{ tip }}">{{ tip }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Garanti Kapsamƒ±</label>
                                <select class="form-select" name="garanti_kapsami">
                                    <option value="">-- Se√ßin --</option>
                                    <option value="Evet">‚úÖ Garanti ƒ∞√ßi</option>
                                    <option value="Hayƒ±r">‚ùå Garanti Dƒ±≈üƒ±</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Arƒ±za Tanƒ±mƒ± <span class="required-mark">*</span></label>
                            <textarea class="form-control" name="ariza_tanimi" rows="3"
                                placeholder="Arƒ±zayƒ± detaylƒ± a√ßƒ±klayƒ±n..." required></textarea>
                        </div>
                    </div>
                </div>

                <!-- Yapƒ±lan ƒ∞≈ülem -->
                <div class="form-card">
                    <div class="form-card-header bg-action">
                        <i class="fas fa-wrench"></i>
                        Yapƒ±lan ƒ∞≈ülem
                    </div>
                    <div class="form-card-body">
                        <div class="mb-3">
                            <label class="form-label">ƒ∞≈ülem A√ßƒ±klamasƒ±</label>
                            <textarea class="form-control" name="yapilan_islem" rows="2"
                                placeholder="Yapƒ±lan i≈ülemleri a√ßƒ±klayƒ±n..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Aksiyon</label>
                            <select class="form-select" name="aksiyon">
                                <option value="">-- Se√ßin --</option>
                                <option value="Tamir">üîß Tamir Edildi</option>
                                <option value="Deƒüi≈üim">üîÑ Par√ßa Deƒüi≈ütirildi</option>
                                <option value="Ayar">‚öôÔ∏è Ayar Yapƒ±ldƒ±</option>
                                <option value="Reset">üîÉ Reset Atƒ±ldƒ±</option>
                                <option value="Beklemede">‚è≥ Par√ßa Bekleniyor</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Par√ßa Bilgileri -->
                <div class="form-card">
                    <div class="form-card-header bg-part">
                        <i class="fas fa-puzzle-piece"></i>
                        Par√ßa Bilgileri
                    </div>
                    <div class="form-card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Par√ßa Kodu (Bile≈üen Numarasƒ±)</label>
                                <div class="position-relative">
                                    <input type="text" class="form-control" id="parca_kodu_input" name="parca_kodu"
                                        placeholder="Bile≈üen numarasƒ± yazƒ±n..." autocomplete="off">
                                    <ul class="list-group position-absolute w-100" id="parca_kodu_list"
                                        style="display:none; z-index:1000;">
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Par√ßa Adƒ± (Nesne Kƒ±sa Metni)</label>
                                <div class="position-relative">
                                    <input type="text" class="form-control" id="parca_adi_input" name="parca_adi"
                                        placeholder="Nesne kƒ±sa metni yazƒ±n..." autocomplete="off">
                                    <ul class="list-group position-absolute w-100" id="parca_adi_list"
                                        style="display:none; z-index:1000;">
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Par√ßa Seri Numarasƒ±</label>
                                <input type="text" class="form-control" name="parca_seri_no"
                                    placeholder="Seri numarasƒ± yazƒ±n...">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Adedi</label>
                                <input type="number" class="form-control" name="adedi" min="1" step="1"
                                    placeholder="Par√ßa adedini yazƒ±n...">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Seri No</label>
                                <input type="text" class="form-control" name="seri_numarasi" placeholder="S/N">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Adet</label>
                                <input type="number" class="form-control" name="adet" min="1" value="1">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">ƒ∞≈ü√ßilik √úcreti <small
                                        class="text-muted">(Fixed)</small></label>
                                <input type="number" class="form-control" name="iscilik_maliyeti" step="0.01"
                                    value="11.00" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Servise Verili≈ü -->
                <div class="form-card">
                    <div class="form-card-header bg-vehicle">
                        <i class="fas fa-check-circle"></i>
                        Servise Verili≈ü
                    </div>
                    <div class="form-card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tarih <small class="text-muted">(Tamir Biti≈ü'ten
                                        Otomatik)</small></label>
                                <input type="date" class="form-control" name="servise_verilis_tarih" id="serviseTarih"
                                    readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Saat <small class="text-muted">(Tamir Biti≈ü'ten
                                        Otomatik)</small></label>
                                <input type="time" class="form-control" name="servise_verilis_saat" id="serviseSaat">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Butonlar -->
        <div style="display: flex; justify-content: center; gap: 1rem; padding: 1rem 0; flex-wrap: wrap;">
            <a href="{{ url_for('fracas.index') }}" class="btn-back">
                <i class="fas fa-arrow-left"></i>Geri D√∂n
            </a>
            <button type="submit" class="btn-submit">
                <i class="fas fa-save"></i>Kaydet
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script type="text/javascript">
    // Dinamik sistem detaylarƒ±
    var sistem_detay = {{ sistem_detay | tojson | safe }};
    var modules = {{ modules | tojson | safe }};
    console.log('Ara√ß mod√ºlleri:', modules);
    console.log('Sistem detaylarƒ±:', sistem_detay);
    document.addEventListener('DOMContentLoaded', function () {
        var sistemSelect = document.getElementById('sistemSelect');
        var altSistemSelect = document.getElementById('altSistemSelect');
        var tedarikciSelect = document.getElementById('tedarikciSelect');
        if (sistemSelect) {
            sistemSelect.addEventListener('change', function () {
                var sistem = this.value;
                altSistemSelect.innerHTML = '<option value="">-- Se√ßin --</option>';
                tedarikciSelect.innerHTML = '<option value="">-- Se√ßin --</option>';
                if (sistem && sistem_detay[sistem]) {
                    var data = sistem_detay[sistem];
                    console.log('Se√ßilen sistem:', sistem, data);
                    (data.tedarikciler || []).forEach(function (ted) {
                        tedarikciSelect.innerHTML += '<option value="' + ted + '">' + ted + '</option>';
                    });
                    (data.alt_sistemler || []).forEach(function (alt) {
                        altSistemSelect.innerHTML += '<option value="' + alt + '">' + alt + '</option>';
                    });

                    // Tedarik√ßi otomatik olarak 1. option'u se√ß (varsa)
                    var options = tedarikciSelect.querySelectorAll('option');
                    if (options.length > 1) {  // 0 index -- Se√ßin -- olduƒüu i√ßin, 1 adet tedarik√ßi demek index 1
                        tedarikciSelect.selectedIndex = 1;
                    }
                } else {
                    console.log('Se√ßilen sistem i√ßin detay bulunamadƒ±:', sistem);
                }
            });
        }
    });
    // Tamir s√ºresi hesaplama + Servise verili≈ü tarihini otomatik doldur
    var tamirInputs = ['tamirBasTarih', 'tamirBasSaat', 'tamirBitTarih', 'tamirBitSaat'];
    tamirInputs.forEach(function (id) {
        var el = document.getElementById(id);
        if (el) {
            el.addEventListener('change', hesaplaTamirSuresi);
        }
    });
    function hesaplaTamirSuresi() {
        var hataTarih = document.querySelector('input[name="hata_tarih"]').value;
        var hataSaat = document.querySelector('input[name="hata_saat"]').value;
        var bd = document.getElementById('tamirBasTarih').value;
        var bs = document.getElementById('tamirBasSaat').value;
        var ed = document.getElementById('tamirBitTarih').value;
        var es = document.getElementById('tamirBitSaat').value;

        // Tamir ba≈ülama zamanƒ± hata zamanƒ±ndan √∂nce olamaz
        if (bd && bs) {
            var hataZamani = hataTarih && hataSaat ? new Date(hataTarih + 'T' + hataSaat) : null;
            var tamirBasZamani = new Date(bd + 'T' + bs);

            if (hataZamani && tamirBasZamani < hataZamani) {
                alert('‚ö†Ô∏è Tamir ba≈ülama zamanƒ±, hata zamanƒ±ndan √∂nce olamaz!');
                document.getElementById('tamirBasTarih').value = '';
                document.getElementById('tamirBasSaat').value = '';
                return;
            }
        }

        if (bd && bs && ed && es) {
            var start = new Date(bd + 'T' + bs);
            var end = new Date(ed + 'T' + es);

            // Biti≈ü tarihi ba≈ülamadan sonra olmalƒ±
            if (end < start) {
                alert('‚ö†Ô∏è Biti≈ü tarihi ba≈ülama tarihinden sonra olmalƒ±dƒ±r!');
                document.getElementById('tamirBitTarih').value = '';
                document.getElementById('tamirBitSaat').value = '';
                return;
            }

            var diff = Math.max(0, end - start);
            var h = Math.floor(diff / 3600000);
            var m = Math.floor((diff % 3600000) / 60000);
            var totalMinutes = Math.floor(diff / 60000);

            document.getElementById('tamirSuresi').value = h + ' saat ' + m + ' dakika';
            document.getElementById('mttr').value = totalMinutes + ' dk';

            // Servise verili≈ü tarihini ve saatini biti≈ü tarih/saatine e≈üitle
            document.getElementById('serviseTarih').value = ed;
            document.getElementById('serviseSaat').value = es;
        }
    }

    // Servise verili≈ü tarihi validasyonu
    document.getElementById('serviseTarih').addEventListener('change', function () {
        var ed = document.getElementById('tamirBitTarih').value;
        var serviseTarih = this.value;

        if (ed && serviseTarih) {
            var tamirBitis = new Date(ed);
            var serviseVerilis = new Date(serviseTarih);

            if (serviseVerilis < tamirBitis) {
                alert('‚ö†Ô∏è Servise verili≈ü tarihi, tamir biti≈ü tarihinden √∂nce olamaz!');
                document.getElementById('serviseTarih').value = '';
                return;
            }
        }
    });

    // Aksiyon se√ßimine g√∂re Par√ßa Bilgileri b√∂l√ºm√ºn√º g√∂ster/gizle
    var aksiyon_select = document.querySelector('select[name="aksiyon"]');
    var parca_section = document.querySelector('.bg-part').closest('.form-card');

    function toggleParcaBilgileri() {
        var selected_action = aksiyon_select.value;
        // "Deƒüi≈üim" se√ßilirse par√ßa alanlarƒ±nƒ± g√∂ster
        if (selected_action === 'Deƒüi≈üim' || selected_action === 'Beklemede') {
            parca_section.style.display = 'block';
            // Par√ßa alanlarƒ±nƒ± zorunlu yap
            document.querySelector('input[name="parca_kodu"]').required = true;
            document.querySelector('input[name="parca_adi"]').required = true;
        } else {
            parca_section.style.display = 'none';
            // Par√ßa alanlarƒ±nƒ± zorunlu olmaktan √ßƒ±kar
            document.querySelector('input[name="parca_kodu"]').required = false;
            document.querySelector('input[name="parca_adi"]').required = false;
        }
    }

    // Ba≈ülangƒ±√ßta kontrol et
    toggleParcaBilgileri();

    // Aksiyon se√ßimi deƒüi≈üirse kontrol et
    if (aksiyon_select) {
        aksiyon_select.addEventListener('change', toggleParcaBilgileri);
    }
</script>
{% endblock %}