{% extends 'base.html' %}

{% block title %}Arıza Listesi - Veriler{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="page-title">Arıza Listesi - Veriler
            <span class="badge bg-secondary fs-6">logs/ariza_listesi/</span>
        </h1>
        <p class="page-subtitle">logs/ariza_listesi/ klasöründen Arıza Listesi Excel verilerini görüntüleyin ve işleyin
        </p>
    </div>
    <div>
        <a href="{{ url_for('ariza_listesi_veriler_export') }}" class="btn btn-info me-2">
            <i class="bi bi-download me-2"></i>Excel'e İndir
        </a>
        <form method="POST" action="{{ url_for('ariza_listesi_veriler_process') }}" style="display: inline;">
            <button type="submit" class="btn btn-success"
                onclick="return confirm('⚠️ Bu işlem veriyi işleyecek. Emin misin?');">
                <i class="bi bi-play-fill me-2"></i>Verileri İşle
            </button>
        </form>
    </div>
</div>

<!-- Stats -->
<div class="row g-3 mb-4">
    <div class="col-12 col-md-6">
        <div class="stat-card">
            <div class="stat-icon primary">
                <i class="bi bi-list-check"></i>
            </div>
            <div class="stat-content">
                <h3>{{ row_count }}</h3>
                <p>Toplam Kayıt</p>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-6">
        <div class="stat-card">
            <div class="stat-icon info">
                <i class="bi bi-calendar-event"></i>
            </div>
            <div class="stat-content">
                <h3 style="font-size: 1.2rem;">{{ file_date }}</h3>
                <p>Dosya Tarihi</p>
            </div>
        </div>
    </div>
</div>

<!-- Failure List -->
<div class="card">
    <div class="card-body">
        <!-- Filters -->
        <div class="row mb-3 g-2">
            <div class="col-12 col-md-4">
                <label class="form-label fw-bold">Araç No</label>
                <select id="filterAracNo" class="form-select form-select-sm">
                    <option value="">Tümü</option>
                </select>
            </div>
            <div class="col-12 col-md-4">
                <label class="form-label fw-bold">Tedarikçi</label>
                <select id="filterTedarikci" class="form-select form-select-sm">
                    <option value="">Tümü</option>
                </select>
            </div>
            <div class="col-12 col-md-4">
                <label class="form-label fw-bold">Arıza Sınıfı</label>
                <select id="filterArizaSinifi" class="form-select form-select-sm">
                    <option value="">Tümü</option>
                </select>
            </div>
        </div>
        <hr class="my-2">
    </div>

    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0 table-sm" id="failureTable">
                <thead class="table-dark sticky-top">
                    <tr>
                        <th style="width: 5%; min-width: 40px;">#</th>
                        <th style="min-width: 120px;">FRACAS ID</th>
                        <th style="min-width: 100px;">Araç No</th>
                        <th style="min-width: 120px;">Sistem</th>
                        <th style="min-width: 120px;">Alt Sistem</th>
                        <th style="min-width: 100px;">Tarih</th>
                        <th style="min-width: 80px;">Saat</th>
                        <th style="min-width: 100px;">Arıza Sınıfı</th>
                        <th style="min-width: 150px;">Garanti Kapsamı</th>
                        <th style="min-width: 150px;">Arıza Tanımı</th>
                        <th style="width: 5%; min-width: 40px;">Detay</th>
                    </tr>
                </thead>
                <tbody>
                    {% if rows %}
                    {% for i, row in enumerate(rows, 1) %}
                    <tr style="cursor: pointer;" onclick="toggleRow({{ i }})">
                        <td class="fw-bold text-primary">{{ i }}</td>
                        <td>
                            <span class="badge bg-primary">{{ row[0] or '-' }}</span>
                        </td>
                        <td>
                            <span class="badge bg-info">{{ row[1] or '-' }}</span>
                        </td>
                        <td><small>{{ row[6] or '-' }}</small></td>
                        <td><small>{{ row[7] or '-' }}</small></td>
                        <td><small>{{ row[4] or '-' }}</small></td>
                        <td><small>{{ row[5] or '-' }}</small></td>
                        <td>
                            {% set sinif = row[9]|string %}
                            {% if sinif.startswith('A') %}
                            <span class="badge bg-danger">{{ row[9] or '-' }}</span>
                            {% elif sinif.startswith('B') %}
                            <span class="badge" style="background-color: #FF8C00; color: white;">{{ row[9] or '-'
                                }}</span>
                            {% elif sinif.startswith('C') %}
                            <span class="badge" style="background-color: #FFD700; color: #333;">{{ row[9] or '-'
                                }}</span>
                            {% elif sinif.startswith('D') %}
                            <span class="badge" style="background-color: #28a745; color: white;">{{ row[9] or '-'
                                }}</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ row[9] or '-' }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <small>
                                {% set warranty = row[12]|string %}
                                {% if warranty|length > 40 %}
                                {{ warranty[:35] }}...
                                {% else %}
                                {{ warranty or '-' }}
                                {% endif %}
                            </small>
                        </td>
                        <td>
                            <small>
                                {% set desc = row[13]|string %}
                                {% if desc|length > 50 %}
                                {{ desc[:45] }}...
                                {% else %}
                                {{ desc or '-' }}
                                {% endif %}
                            </small>
                        </td>
                        <td style="text-align: center;">
                            <i class="bi bi-chevron-down text-muted"></i>
                        </td>
                    </tr>
                    <!-- Detay Satırı -->
                    <tr class="detail-row collapse" id="details-{{ i }}">
                        <td colspan="11">
                            <div class="p-3 bg-light">
                                <h6 class="text-primary mb-3">Tüm Detaylar</h6>
                                <div class="row">
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <dt class="fw-bold small">Arıza Sınıfı</dt>
                                        <dd class="small mb-0">
                                            {% set sinif = row[9]|string %}
                                            {% if sinif.startswith('A') %}
                                            <span class="badge bg-danger">{{ row[9] or '-' }}</span>
                                            {% elif sinif.startswith('B') %}
                                            <span class="badge" style="background-color: #FF8C00; color: white;">{{
                                                row[9] or '-'
                                                }}</span>
                                            {% elif sinif.startswith('C') %}
                                            <span class="badge" style="background-color: #FFD700; color: #333;">{{
                                                row[9] or '-' }}</span>
                                            {% elif sinif.startswith('D') %}
                                            <span class="badge" style="background-color: #28a745; color: white;">{{
                                                row[9] or '-' }}</span>
                                            {% else %}
                                            <span class="badge bg-secondary">{{ row[9] or '-' }}</span>
                                            {% endif %}
                                        </dd>
                                    </div>
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <dt class="fw-bold small">Arıza Kaynağı</dt>
                                        <dd class="small mb-0">{{ row[10] or '-' }}</dd>
                                    </div>
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <dt class="fw-bold small">Arıza Tipi</dt>
                                        <dd class="small mb-0">{{ row[11] or '-' }}</dd>
                                    </div>
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <dt class="fw-bold small">Tedarikçi</dt>
                                        <dd class="small mb-0">{{ row[8] or '-' }}</dd>
                                    </div>
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <dt class="fw-bold small">Garanti Kapsamı</dt>
                                        <dd class="small mb-0">{{ row[12] or '-' }}</dd>
                                    </div>
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <dt class="fw-bold small">Arıza Tanımı</dt>
                                        <dd class="small mb-0">{{ row[13] or '-' }}</dd>
                                    </div>
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <dt class="fw-bold small">Yapılan İşlem</dt>
                                        <dd class="small mb-0">{{ row[14] or '-' }}</dd>
                                    </div>
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <dt class="fw-bold small">Aksiyon</dt>
                                        <dd class="small mb-0">{{ row[15] or '-' }}</dd>
                                    </div>
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <dt class="fw-bold small">Parça Kodu</dt>
                                        <dd class="small mb-0">{% if 'Yok' in (row[16]|string) or row[16]|string ==
                                            'nan' %}Yok{% else %}{{ row[16] or 'Yok' }}{% endif %}</dd>
                                    </div>
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <dt class="fw-bold small">Parça Adı</dt>
                                        <dd class="small mb-0">{% if 'Yok' in (row[17]|string) or row[17]|string ==
                                            'nan' %}Yok{% else %}{{ row[17] or 'Yok' }}{% endif %}</dd>
                                    </div>
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <dt class="fw-bold small">Parça Seri No</dt>
                                        <dd class="small mb-0">{% if 'Yok' in (row[18]|string) or row[18]|string ==
                                            'nan' %}Yok{% else %}{{ row[18] or '-' }}{% endif %}</dd>
                                    </div>
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <dt class="fw-bold small">Adedi</dt>
                                        <dd class="small mb-0">{{ row[19] if row[19] != 0 else '-' }}</dd>
                                    </div>
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <dt class="fw-bold small">Tamir Başlama Tarihi</dt>
                                        <dd class="small mb-0">{{ row[20] or '-' }}</dd>
                                    </div>
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <dt class="fw-bold small">Tamir Başlama Saati</dt>
                                        <dd class="small mb-0">{{ row[21] or '-' }}</dd>
                                    </div>
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <dt class="fw-bold small">Tamir Bitişi Tarihi</dt>
                                        <dd class="small mb-0">{{ row[22] or '-' }}</dd>
                                    </div>
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <dt class="fw-bold small">Tamir Bitişi Saati</dt>
                                        <dd class="small mb-0">{{ row[23] or '-' }}</dd>
                                    </div>
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <dt class="fw-bold small">Tamir Süresi</dt>
                                        <dd class="small mb-0">{{ row[24] or '-' }}</dd>
                                    </div>
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <dt class="fw-bold small">MTTR (dk)</dt>
                                        <dd class="small mb-0">{{ row[25] or '-' }}</dd>
                                    </div>
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <dt class="fw-bold small">Servise Veriliş Tarihi</dt>
                                        <dd class="small mb-0">{{ row[26] or '-' }}</dd>
                                    </div>
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <dt class="fw-bold small">Servise Veriliş Saati</dt>
                                        <dd class="small mb-0">{{ row[27] or '-' }}</dd>
                                    </div>
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <dt class="fw-bold small">Durum</dt>
                                        <dd class="small mb-0"><span class="badge bg-success">{{ row[28] or '-'
                                                }}</span></dd>
                                    </div>
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <dt class="fw-bold small">Personel Sayısı</dt>
                                        <dd class="small mb-0">{% if row|length > 29 and row[29] != 0 %}{{ row[29] }}{%
                                            elif row|length > 29 and row[29] == 0 %}0{% else %}-{% endif %}</dd>
                                    </div>
                                </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="11" class="text-center py-5">
                            <i class="bi bi-inbox text-muted" style="font-size: 48px;"></i>
                            <p class="text-muted mt-3">Veri bulunamadı</p>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .detail-row {
        display: none;
    }

    .detail-row.show {
        display: table-row;
    }

    .sticky-top {
        position: sticky;
        top: 0;
        z-index: 10;
    }
</style>

<script>
    // Toggle detail row
    function toggleRow(idx) {
        const detailRow = document.getElementById('details-' + idx);
        if (detailRow) {
            detailRow.classList.toggle('show');
        }
    }

    // Filter functionality
    const rows = document.querySelectorAll('#failureTable tbody tr:not(.detail-row)');
    const detailRows = document.querySelectorAll('#failureTable tbody tr.detail-row');

    // Collect unique values for filters
    const aracNoSet = new Set();
    const tedarikciSet = new Set();
    const arizaSinifiSet = new Set();

    // Build filter options from table data
    rows.forEach((row, idx) => {
        const badges = row.querySelectorAll('span.badge');

        // Araç No is second badge
        if (badges.length >= 2) {
            const aracNo = badges[1]?.textContent?.trim();
            if (aracNo) aracNoSet.add(aracNo);
        }

        // Arıza Sınıfı is third badge
        if (badges.length >= 3) {
            const arizaSinifi = badges[2]?.textContent?.trim();
            if (arizaSinifi) arizaSinifiSet.add(arizaSinifi);
        }

        // Tedarikçi from detail row
        const detailRow = row.nextElementSibling;
        if (detailRow && detailRow.classList.contains('detail-row')) {
            const ddElements = detailRow.querySelectorAll('dd.small');
            if (ddElements.length > 3) {
                const tedarikci = ddElements[3]?.textContent?.trim();
                if (tedarikci && tedarikci !== '-') tedarikciSet.add(tedarikci);
            }
        }
    });

    // Populate dropdowns
    const aracNoSelect = document.getElementById('filterAracNo');
    const tedarikciSelect = document.getElementById('filterTedarikci');
    const arizaSinifiSelect = document.getElementById('filterArizaSinifi');

    [...aracNoSet].sort().forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        aracNoSelect.appendChild(option);
    });

    [...tedarikciSet].sort().forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        tedarikciSelect.appendChild(option);
    });

    [...arizaSinifiSet].sort().forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        arizaSinifiSelect.appendChild(option);
    });

    // Filter function
    function applyFilters() {
        const filterAracNo = document.getElementById('filterAracNo').value;
        const filterTedarikci = document.getElementById('filterTedarikci').value;
        const filterArizaSinifi = document.getElementById('filterArizaSinifi').value;

        rows.forEach((row, idx) => {
            const badges = row.querySelectorAll('span.badge');
            const aracNo = badges.length >= 2 ? badges[1]?.textContent?.trim() : '';
            const arizaSinifi = badges.length >= 3 ? badges[2]?.textContent?.trim() : '';

            // Get tedarikçi from detail row
            const detailRow = row.nextElementSibling;
            let tedarikci = '';
            if (detailRow && detailRow.classList.contains('detail-row')) {
                const ddElements = detailRow.querySelectorAll('dd.small');
                if (ddElements.length > 3) {
                    tedarikci = ddElements[3]?.textContent?.trim() || '';
                }
            }

            // Apply filters
            let show = true;
            if (filterAracNo && !aracNo.includes(filterAracNo)) show = false;
            if (filterTedarikci && !tedarikci.includes(filterTedarikci)) show = false;
            if (filterArizaSinifi && !arizaSinifi.includes(filterArizaSinifi)) show = false;

            row.style.display = show ? '' : 'none';
            if (detailRow && detailRow.classList.contains('detail-row')) {
                detailRow.style.display = show ? '' : 'none';
            }
        });
    }

    // Add event listeners to filters
    aracNoSelect.addEventListener('change', applyFilters);
    tedarikciSelect.addEventListener('change', applyFilters);
    arizaSinifiSelect.addEventListener('change', applyFilters);
</script>
{% endblock %}