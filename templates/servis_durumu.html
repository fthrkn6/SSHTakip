{% extends "base.html" %}

{% block title %}Servis Durumu - SSH Takip{% endblock %}

{% block extra_css %}
<style>
    /* Modern Card Styling */
    .stat-card {
        transition: all 0.3s ease;
        border-radius: 12px !important;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15) !important;
    }

    .card-body {
        padding: 1.5rem !important;
    }

    .page-header {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f0f0f0;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        font-size: 0.95rem;
        color: #6b7280;
        margin: 0;
    }

    /* Status Table */
    .status-table {
        font-size: 0.65rem;
    }

    .status-cell {
        padding: 3px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        min-width: 45px;
        border-radius: 4px;
    }

    .status-cell:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .status-service {
        background-color: #10b981 !important;
        border: 1px solid #059669;
        color: white;
        font-weight: 600;
    }

    .status-out {
        background-color: #ef4444 !important;
        border: 1px solid #dc2626;
        color: white;
        font-weight: 600;
    }

    .status-operational {
        background-color: #f59e0b !important;
        border: 1px solid #d97706;
        color: white;
        font-weight: 600;
    }

    .status-empty {
        background-color: #f3f4f6;
        border: 1px solid #e5e7eb;
        color: #9ca3af;
    }

    .tram-row {
        border-bottom: 1px solid #e5e7eb;
    }

    .date-header {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        font-weight: bold;
        padding: 8px 4px;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 10;
        font-size: 0.7rem;
        border-radius: 4px;
    }

    .tram-id-cell {
        background-color: #f9fafb;
        font-weight: bold;
        position: sticky;
        left: 0;
        z-index: 5;
        min-width: 60px;
        font-size: 0.75rem;
        padding: 6px;
        border-right: 2px solid #e5e7eb;
    }

    /* Form Styling */
    .form-label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
    }

    .form-control,
    .form-select {
        border: 1px solid #d1d5db;
        border-radius: 8px;
        padding: 0.65rem 0.75rem;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border: none;
        border-radius: 8px;
        padding: 0.65rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
    }

    .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border: none;
        border-radius: 8px;
        padding: 0.65rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
    }

    .btn-warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        border: none;
        border-radius: 8px;
        padding: 0.65rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
        color: white;
    }

    .btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3);
        color: white;
    }

    .btn-info {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        border: none;
        border-radius: 8px;
        padding: 0.65rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
        color: white;
    }

    .btn-info:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(6, 182, 212, 0.3);
        color: white;
    }

    /* Sticky Export Button */
    .sticky-export-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border: none;
        color: white;
        cursor: pointer;
    }

    .sticky-export-btn:hover {
        transform: scale(1.15);
        box-shadow: 0 12px 32px rgba(59, 130, 246, 0.4);
    }

    .sticky-export-btn:active {
        transform: scale(0.95);
    }

    .export-menu {
        position: fixed;
        bottom: 100px;
        right: 30px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 32px rgba(0, 0, 0, 0.15);
        display: none;
        flex-direction: column;
        z-index: 999;
        min-width: 200px;
        overflow: hidden;
    }

    .export-menu.show {
        display: flex;
    }

    .export-menu a {
        padding: 12px 16px;
        color: #374151;
        text-decoration: none;
        border-bottom: 1px solid #f3f4f6;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .export-menu a:last-child {
        border-bottom: none;
    }

    .export-menu a:hover {
        background-color: #f9fafb;
        color: #3b82f6;
        padding-left: 24px;
    }

    .tabs-container {
        margin-top: 2rem;
        border-top: 2px solid #e5e7eb;
        padding-top: 1rem;
    }

    .nav-tabs {
        border-bottom: 2px solid #e5e7eb;
    }

    .nav-link {
        color: #6b7280;
        border: none;
        border-bottom: 3px solid transparent;
        border-radius: 0;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .nav-link:hover {
        color: #3b82f6;
        border-bottom-color: #dbeafe;
    }

    .nav-link.active {
        color: #3b82f6;
        background-color: transparent;
        border-bottom-color: #3b82f6;
    }

    .report-card {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .report-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .root-cause-form {
        background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .metric-box {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        border-left: 4px solid #3b82f6;
        margin-bottom: 1rem;
    }

    .metric-label {
        font-size: 0.85rem;
        color: #6b7280;
        font-weight: 500;
        margin-bottom: 0.25rem;
    }

    .metric-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1f2937;
    }

    @media (max-width: 768px) {
        .sticky-export-btn {
            width: 50px;
            height: 50px;
            bottom: 20px;
            right: 20px;
            font-size: 1.25rem;
        }

        .export-menu {
            bottom: 80px;
            right: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Sticky Export Button Panel -->
<div id="stickyExportBtn" class="sticky-export-btn" title="Raporları İndir">
    <i class="bi bi-download"></i>
</div>

<!-- Export Menu (Dropdown) -->
<div id="exportMenu" class="export-menu">
    <a href="/servis/excel/comprehensive-report" target="_blank">
        <i class="bi bi-file-earmark-excel"></i> Kapsamlı Rapor
    </a>
    <a href="/servis/excel/root-cause-report" target="_blank">
        <i class="bi bi-file-earmark-excel"></i> Root Cause Analizi
    </a>
    <a href="javascript:void(0)" onclick="downloadDailyReport()">
        <i class="bi bi-file-earmark-excel"></i> Günlük Rapor
    </a>
</div>

<div class="page-header">
    <h1 class="page-title"><i class="bi bi-toggle-on me-2"></i>Servis Durumu</h1>
    <p class="page-subtitle">Tramvay servis durumlarını yönet ve haftalık takvimini görüntüle</p>
</div>

<!-- İstatistikler - Modern Dashboard - 5 Kartlı -->
<div class="d-flex gap-1 mb-3">
    <div style="flex: 1;">
        <div class="card stat-card shadow-sm"
            style="border: none; border-left: 4px solid #10b981; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 0.5rem; height: 100%;">
            <div class="d-flex justify-content-between align-items-center gap-2">
                <div>
                    <h6 class="mb-0 text-muted" style="font-size: 0.85rem; font-weight: 600;">Serviste</h6>
                    <h3 class="mb-0" style="font-size: 1.75rem; font-weight: 700; color: #10b981;">{{
                        stats.get('Servis',
                        0) or stats.Servis or '0' }}</h3>
                </div>
                <i class="bi bi-check-circle text-success" style="font-size: 1.3rem;"></i>
            </div>
        </div>
    </div>
    <div style="flex: 1;">
        <div class="card stat-card shadow-sm"
            style="border: none; border-left: 4px solid #ef4444; background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); padding: 0.5rem; height: 100%;">
            <div class="d-flex justify-content-between align-items-center gap-2">
                <div>
                    <h6 class="mb-0 text-muted" style="font-size: 0.85rem; font-weight: 600;">Servis Dışı</h6>
                    <h3 class="mb-0" style="font-size: 1.75rem; font-weight: 700; color: #ef4444;">{{ stats.get('Servis
                        Dışı', 0) or stats['Servis Dışı'] or '0' }}</h3>
                </div>
                <i class="bi bi-x-circle text-danger" style="font-size: 1.3rem;"></i>
            </div>
        </div>
    </div>
    <div style="flex: 1;">
        <div class="card stat-card shadow-sm"
            style="border: none; border-left: 4px solid #f59e0b; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); padding: 0.5rem; height: 100%;">
            <div class="d-flex justify-content-between align-items-center gap-2">
                <div>
                    <h6 class="mb-0 text-muted" style="font-size: 0.85rem; font-weight: 600;">İşletme</h6>
                    <h3 class="mb-0" style="font-size: 1.75rem; font-weight: 700; color: #f59e0b;">{{ stats.get('İşletme
                        Kaynaklı Servis Dışı', 0) or stats['İşletme Kaynaklı Servis Dışı'] or '0' }}</h3>
                </div>
                <i class="bi bi-exclamation-circle text-warning" style="font-size: 1.3rem;"></i>
            </div>
        </div>
    </div>
    <div style="flex: 1;">
        <div class="card stat-card shadow-sm"
            style="border: none; border-left: 4px solid #6366f1; background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%); padding: 0.5rem; height: 100%;">
            <div class="d-flex justify-content-between align-items-center gap-2">
                <div>
                    <h6 class="mb-0 text-muted" style="font-size: 0.85rem; font-weight: 600;">Toplam</h6>
                    <h3 class="mb-0" style="font-size: 1.75rem; font-weight: 700; color: #6366f1;">{{ tramvaylar|length
                        }}</h3>
                </div>
                <i class="bi bi-bus-front text-primary" style="font-size: 1.3rem;"></i>
            </div>
        </div>
    </div>
    <div style="flex: 1;">
        <div class="card stat-card shadow-sm"
            style="border: none; border-top: 4px solid #3b82f6; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); padding: 0.5rem; height: 100%;">
            <div class="d-flex justify-content-between align-items-center gap-2">
                <div>
                    <h6 class="mb-0 text-muted" style="font-size: 0.85rem; font-weight: 600;">Availability</h6>
                    <h3 class="mb-0" style="font-size: 1.75rem; font-weight: 800; color: #3b82f6;">{{
                        stats.get('erisebilirlik', '0%') }}</h3>
                </div>
                <i class="bi bi-speedometer2 text-info" style="font-size: 1.3rem;"></i>
            </div>
        </div>
    </div>
</div>

<!-- Form -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Yeni Durum Girişi</h5>
    </div>
    <div class="card-body">
        <form method="POST" action="/servis-durumu">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Tarih</label>
                    <input type="date" class="form-control" name="tarih" value="{{ today }}" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Tramvay ID</label>
                    <select class="form-select" name="tramvay_id" id="tramvay_id" required>
                        <option value="">Seçiniz</option>
                        {% for tram in tram_ids %}<option value="{{ tram }}">{{ tram }}</option>{% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Durum</label>
                    <select class="form-select" name="durum" id="durum" required>
                        <option value="">Seçiniz</option>
                        <option value="Servis">Servis</option>
                        <option value="Servis Dışı">Servis Dışı</option>
                        <option value="İşletme Kaynaklı Servis Dışı">İşletme Kaynaklı Servis Dışı</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Sistem</label>
                    <select class="form-select" name="sistem" id="sistem" disabled>
                        <option value="">Seçiniz</option>
                        {% for sistem_adi in sistemler.keys() %}<option value="{{ sistem_adi }}">{{ sistem_adi }}
                        </option>{% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Alt Sistem</label>
                    <select class="form-select" name="alt_sistem" id="alt_sistem" disabled>
                        <option value="">Seçiniz</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Açıklama (Opsiyonel)</label>
                    <input type="text" class="form-control" name="aciklama" id="aciklama"
                        placeholder="Detay girebilirsiniz...">
                </div>
            </div>
            <div class="mt-3 d-flex gap-2">
                <button type="submit" class="btn btn-success"><i class="bi bi-check-circle me-2"></i>Kaydet</button>
                <button type="button" class="btn btn-warning" data-bs-toggle="modal"
                    data-bs-target="#topluServiseAlModal">
                    <i class="bi bi-bus-front me-2"></i>Tüm Araçları Servise Al
                </button>
                <button type="button" class="btn btn-info" onclick="gecenGunuTekrarYukle()">
                    <i class="bi bi-arrow-repeat me-2"></i>Dün'ü Tekrar Yükle
                </button>
            </div>
        </form>
    </div>
</div>

<!-- 7 Günlük Tablo -->
<div class="card shadow-sm">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-calendar-week me-2"></i>Haftalık Servis Durumu</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-bordered status-table mb-0">
                <thead>
                    <tr>
                        <th class="date-header tram-id-cell">Araç</th>{% for date in dates %}<th class="date-header">{{
                            date[-2:] }}/{{ date[5:7] }}</th>{% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for tram_id in tram_ids %}<tr class="tram-row">
                        <td class="tram-id-cell"><strong>{{ tram_id }}</strong></td>
                        {% for date in dates %}{%- set si = status_matrix.get(tram_id, {}).get(date) %}
                        {%- if si and si[0] == 'Servis Dışı' %}{%- set aciklama_text = si[3].replace('(Dünden
                        kopyalandı)', '').strip() if si[3] else '' %}{%- set tooltip_text = (si[1] or '') + ((' / ' +
                        si[2]) if si[2] else '') + ((' - ' + aciklama_text) if aciklama_text else '') %}{%- endif %}
                        {%- if si and si[0] == 'Servis' %}<td class="status-cell status-service"><i
                                class="bi bi-check-lg" style="font-size: 1rem; color: white; font-weight: bold;"></i>
                        </td>
                        {%- elif si and si[0] == 'Servis Dışı' %}<td class="status-cell status-out"
                            title="{{ tooltip_text if si else '' }}" data-bs-toggle="tooltip"><i class="bi bi-x-lg"
                                style="font-size: 1rem; color: white; font-weight: bold;"></i></td>
                        {%- elif si and si[0] == 'İşletme Kaynaklı Servis Dışı' %}<td class="status-cell"
                            style="background-color: #ff9800 !important; border: 1px solid #e68900;"><i
                                class="bi bi-exclamation-triangle-fill"
                                style="font-size: 1rem; color: white; font-weight: bold;"></i></td>
                        {%- else %}<td class="status-cell status-empty">-</td>
                        {%- endif %}
                        {%- endfor %}
                    </tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer" style="padding: 0.75rem;">
        <div class="row text-center">
            <div class="col-3"><span class="badge bg-success" style="padding: 4px 8px;"><i
                        class="bi bi-check-lg me-1"></i>Servis</span></div>
            <div class="col-3"><span class="badge bg-danger" style="padding: 4px 8px;"><i
                        class="bi bi-x-lg me-1"></i>Servis Dışı</span></div>
            <div class="col-3"><span class="badge" style="background: #ff9800; padding: 4px 8px; color: white;"><i
                        class="bi bi-exclamation-triangle-fill me-1"></i>İşletme Kaynaklı</span></div>
            <div class="col-3"><span class="badge bg-secondary" style="padding: 4px 8px;">- Veri Yok</span></div>
        </div>
    </div>
</div>

<!-- Son Güncellemeler -->
<div class="card shadow-sm">
    <div class="card-header" data-bs-toggle="collapse" data-bs-target="#updateHistoryCollapse" style="cursor: pointer;">
        <h5 class="mb-0 d-flex justify-content-between align-items-center">
            <span><i class="bi bi-clock-history me-2"></i>Son Güncellemeler</span>
            <i class="bi bi-chevron-down" id="collapseIcon"></i>
        </h5>
    </div>
    <div class="collapse" id="updateHistoryCollapse">
        <div class="card-body p-0">
            <table class="table table-hover mb-0" style="font-size: 0.8rem;">
                <thead class="table-light">
                    <tr>
                        <th style="padding: 0.4rem;">Tarih</th>
                        <th style="padding: 0.4rem;">Tramvay</th>
                        <th style="padding: 0.4rem;">Durum</th>
                        <th style="padding: 0.4rem;">Sistem</th>
                        <th style="padding: 0.4rem;">Açıklama</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" class="text-center text-muted py-2">Henüz giriş yapılmadı</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Toplu Servise Al Modal -->
<div class="modal fade" id="topluServiseAlModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Onay</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2">Tüm araçları servise almak istediğinizden emin misiniz?</p>
                <p class="text-muted"><strong>Toplam {{ tram_ids|length }} araç</strong> bugüne ait
                    <strong>"Servis"</strong> statusunda kaydedilecektir.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-warning" onclick="topluServiseAl()">Evet, Servise Al</button>
            </div>
        </div>
    </div>
</div>

<script>
    const sistemler_data = {{ sistemler_json | safe }};
    const yesterday_data = {{ yesterday_data | tojson }};
    const tram_ids = {{ tram_ids | tojson }};

    // Tüm araçları servise al
    function topluServiseAl() {
        fetch('/servis-durumu/toplu-servise-al', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ tram_ids: tram_ids })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('✅ ' + data.message);
                    location.reload();
                } else {
                    alert('❌ Hata: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ İşlem sırasında hata oluştu');
            });

        const modal = bootstrap.Modal.getInstance(document.getElementById('topluServiseAlModal'));
        if (modal) modal.hide();
    }

    // Sayfa yüklendiğinde dün'ün verilerini otomatik yükle
    document.addEventListener('DOMContentLoaded', function () {
        if (Object.keys(yesterday_data).length > 0) {
            // Tüm araçlar için dün'ün durumunu al ve bugüne kopyala
            Object.entries(yesterday_data).forEach(([tram_id, data]) => {
                // Burada sadece sessiz yükle, alert gösterme
            });

            // İlk araç seçili olsun ve dün'ün durumu form'da gösterilsin
            if (tram_ids.length > 0) {
                const firstTramId = tram_ids[0];
                document.getElementById('tramvay_id').value = firstTramId;

                // İlk araç için dün'ün durumunu göster
                if (yesterday_data[firstTramId]) {
                    const data = yesterday_data[firstTramId];
                    document.getElementById('durum').value = data.status || '';
                    document.getElementById('aciklama').value = data.aciklama || '';

                    // Sistem de seçiliyse doldur
                    if (data.sistem) {
                        document.getElementById('sistem').value = data.sistem;
                        // Sistem select'i trigger et (change event)
                        document.getElementById('sistem').dispatchEvent(new Event('change'));
                    }
                }
            }

            console.log('✅ Dün\'ün verileri otomatik yüklendi');
        }
    });

    // Tramvay seçimi değiştiğinde dün'ün durumunu göster
    function guncelleFormDunuVeri(tram_id) {
        if (yesterday_data[tram_id]) {
            const data = yesterday_data[tram_id];
            document.getElementById('durum').value = data.status || '';
            document.getElementById('aciklama').value = data.aciklama || '';

            if (data.sistem) {
                document.getElementById('sistem').value = data.sistem;
                document.getElementById('sistem').dispatchEvent(new Event('change'));
            } else {
                document.getElementById('sistem').value = '';
            }
        } else {
            document.getElementById('durum').value = '';
            document.getElementById('sistem').value = '';
            document.getElementById('aciklama').value = '';
        }
    }

    // Tramvay seçim event'i
    document.getElementById('tramvay_id').addEventListener('change', function () {
        guncelleFormDunuVeri(this.value);
    });

    // Tüm araçların dün'ü tekrar yükle
    function gecenGunuTekrarYukle() {
        if (Object.keys(yesterday_data).length === 0) {
            alert('⚠️ Dün için kaydedilmiş durum verisi yok.');
            return;
        }

        if (!confirm('⚠️ TÜM araçları dünün durum verilerine göre güncellemek istediğinize emin misiniz?')) {
            return;
        }

        // Dün'ün verisini bugüne kopyala
        fetch('/api/copy_previous_day', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                yesterday_data: yesterday_data
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('✅ ' + data.message);
                    location.reload();
                } else {
                    alert('❌ Hata: ' + (data.message || 'Bilinmeyen hata'));
                }
            })
            .catch(error => {
                console.error('Hata:', error);
                alert('❌ İşlem sırasında hata oluştu: ' + error);
            });
    }

    document.getElementById('durum').addEventListener('change', function () {
        const sistem = document.getElementById('sistem');
        if (this.value === 'Servis Dışı') {
            sistem.disabled = false;
        } else {
            sistem.disabled = true;
            sistem.value = '';
            document.getElementById('alt_sistem').disabled = true;
            document.getElementById('alt_sistem').value = '';
        }
    });

    // Sistem seçildiğinde Alt Sistemleri doldur
    document.getElementById('sistem').addEventListener('change', function () {
        const alt_sistem_select = document.getElementById('alt_sistem');
        const selected_sistem = this.value;

        // Dropdown'ı temizle
        alt_sistem_select.innerHTML = '<option value="">Seçiniz</option>';

        if (selected_sistem && sistemler_data[selected_sistem]) {
            const alt_sistemler = sistemler_data[selected_sistem].alt_sistemler;
            if (alt_sistemler && alt_sistemler.length > 0) {
                alt_sistemler.forEach(alt_sistem => {
                    const option = document.createElement('option');
                    option.value = alt_sistem;
                    option.textContent = alt_sistem;
                    alt_sistem_select.appendChild(option);
                });
                alt_sistem_select.disabled = false;
            } else {
                alt_sistem_select.disabled = true;
            }
        } else {
            alt_sistem_select.disabled = true;
        }
    });

    const collapseIcon = document.getElementById('collapseIcon');
    if (collapseIcon) {
        document.getElementById('updateHistoryCollapse').addEventListener('show.bs.collapse', function () {
            collapseIcon.classList.remove('bi-chevron-down');
            collapseIcon.classList.add('bi-chevron-up');
        });
        document.getElementById('updateHistoryCollapse').addEventListener('hide.bs.collapse', function () {
            collapseIcon.classList.remove('bi-chevron-up');
            collapseIcon.classList.add('bi-chevron-down');
        });
    }

    // ============ STICKY EXPORT BUTTON ============
    const exportBtn = document.getElementById('stickyExportBtn');
    const exportMenu = document.getElementById('exportMenu');

    if (exportBtn && exportMenu) {
        exportBtn.addEventListener('click', function (e) {
            e.stopPropagation();
            exportMenu.classList.toggle('show');
        });

        document.addEventListener('click', function () {
            exportMenu.classList.remove('show');
        });

        exportMenu.addEventListener('click', function (e) {
            e.stopPropagation();
        });
    }

    // Daily Report Download
    function downloadDailyReport() {
        const tramId = prompt('Tramvay ID gir (örn: TRV-001):');
        if (tramId) {
            window.location.href = `/servis/excel/daily-report/${tramId}`;
        }
    }


    // ============ AVAILABILITY REPORT ============
    async function generateAvailabilityReport(period) {
        const tramId = document.getElementById('tramvay_id').value;
        if (!tramId) {
            alert('Lütfen bir tramvay seçiniz');
            return;
        }

        try {
            const response = await fetch('/servis/durumu/api/raporlar?tram_id=' + tramId + '&period=' + period);
            const data = await response.json();

            if (data.success) {
                displayReportData(data.data, period);
            } else {
                alert('Rapor alınırken hata: ' + data.error);
            }
        } catch (error) {
            console.error('Hata:', error);
            alert('İstek sırasında hata oluştu');
        }
    }

    function displayReportData(reports, period) {
        const container = document.getElementById('reportContainer');
        if (!container) return;

        container.innerHTML = '';

        if (reports.length === 0) {
            container.innerHTML = '<div class="alert alert-info">Bu dönem için rapor bulunamamıştır.</div>';
            return;
        }

        reports.forEach(report => {
            const card = document.createElement('div');
            card.className = 'report-card';
            card.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <h6>Dönem: ${report.start} - ${report.end}</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="metric-box">
                                    <div class="metric-label">Availability</div>
                                    <div class="metric-value">${report.availability.toFixed(2)}%</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-box">
                                    <div class="metric-label">Servis Saatleri</div>
                                    <div class="metric-value">${report.available_hours}</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-box">
                                    <div class="metric-label">Servis Dışı</div>
                                    <div class="metric-value">${report.unavailable_hours}</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-box">
                                    <div class="metric-label">Planlı Bakım</div>
                                    <div class="metric-value">${report.maintenance_hours}</div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-3">
                                <div class="metric-box">
                                    <div class="metric-label">Arızadan Kapalı</div>
                                    <div class="metric-value">${report.failure_hours}</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-box">
                                    <div class="metric-label">İşletme Kaynaklı</div>
                                    <div class="metric-value">${report.downtime_hours}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted">
                            Availability oranı hesaplandı ve loglandı.
                        </small>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    // ============ ROOT CAUSE ANALYSIS ============
    document.getElementById('rootCauseForm')?.addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = {
            tram_id: document.getElementById('tramvay_id').value,
            sistem: document.getElementById('rcaSistem').value,
            alt_sistem: document.getElementById('rcaAltSistem').value,
            root_cause: document.getElementById('rcaRootCause').value,
            immediate_cause: document.getElementById('rcaImmediateCause').value,
            failure_mode: document.getElementById('rcaFailureMode').value,
            severity: document.getElementById('rcaSeverity').value,
            contributing_factors: document.getElementById('rcaFactors').value.split('\n').filter(x => x.trim()),
            corrective_actions: document.getElementById('rcaCorrective').value.split('\n').filter(x => x.trim()),
            preventive_actions: document.getElementById('rcaPreventive').value.split('\n').filter(x => x.trim())
        };

        try {
            const response = await fetch('/servis/durumu/root-cause/ekle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            const data = await response.json();
            if (data.success) {
                alert('✅ Root Cause Analizi başarıyla kaydedildi');
                document.getElementById('rootCauseForm').reset();
            } else {
                alert('❌ Hata: ' + data.error);
            }
        } catch (error) {
            console.error('Hata:', error);
            alert('❌ İstek sırasında hata oluştu');
        }
    });

    // ============ EXCEL EXPORT ============
    document.getElementById('exportAvailabilityBtn')?.addEventListener('click', async function () {
        const tramId = document.getElementById('tramvay_id').value;
        if (!tramId) {
            alert('Lütfen bir tramvay seçiniz');
            return;
        }

        try {
            const response = await fetch('/servis/durumu/excel/rapor', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tram_id: tramId })
            });

            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `availability_analiz_${tramId}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                alert('✅ Excel dosyası indirmeye başladı');
            } else {
                alert('❌ Dosya oluşturulurken hata oluştu');
            }
        } catch (error) {
            console.error('Hata:', error);
            alert('❌ İndirme sırasında hata oluştu');
        }
    });

    // Sayfa yüklendiğinde tooltip'leri başlat
    document.addEventListener('DOMContentLoaded', function () {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
{% endblock %}