{% extends "base.html" %}

{% block title %}Bakƒ±m Planlamasƒ±{% endblock %}

{% block extra_css %}
<style>
    /* ============================================
       GENEL STIL VE LAYOUT
       ============================================ */
    .container-fluid {
        background: linear-gradient(135deg, #f5f7fa 0%, #f0f4f8 100%);
        min-height: 100vh;
        padding-bottom: 2rem;
    }

    .page-title {
        font-size: 2em;
        font-weight: 700;
        color: #1a2332;
        letter-spacing: -0.5px;
    }

    .page-subtitle {
        font-size: 0.95em;
        color: #6c757d;
        font-weight: 400;
        margin-top: 0.25rem;
    }

    /* ============================================
       STAT KARTLARI
       ============================================ */
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #e7edf3;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .stat-card:hover {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        transform: translateY(-2px);
        border-color: #d0d8e0;
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        font-weight: bold;
        color: white;
    }

    .stat-icon.primary {
        background: linear-gradient(135deg, #0d6efd, #0856ca);
    }

    .stat-icon.success {
        background: linear-gradient(135deg, #198754, #145a3e);
    }

    .stat-icon.warning {
        background: linear-gradient(135deg, #ffc107, #ff9800);
    }

    .stat-icon.danger {
        background: linear-gradient(135deg, #dc3545, #c82333);
    }

    .stat-content h3 {
        margin: 0;
        font-size: 1.8em;
        font-weight: 700;
        color: #1a2332;
    }

    .stat-content p {
        margin: 4px 0 0 0;
        color: #6c757d;
        font-size: 0.9em;
        font-weight: 500;
    }

    /* ============================================
       TABLO STILLERI
       ============================================ */
    .table-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #e7edf3;
        overflow: hidden;
    }

    .table-card .table-responsive {
        border-radius: 12px;
        overflow: hidden;
    }

    .table-card .table {
        margin-bottom: 0;
        border-collapse: collapse;
    }

    .table-card thead {
        background: linear-gradient(135deg, #1a2332 0%, #2c3e50 100%);
    }

    .table-card thead th {
        font-size: 1.05em;
        font-weight: 600;
        padding: 16px 12px;
        letter-spacing: 0.5px;
        color: white;
        border: none;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .table-card tbody td {
        padding: 14px 12px;
        vertical-align: middle;
        border-bottom: 1px solid #e7edf3;
        font-size: 0.95em;
    }

    .table-card tbody tr {
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
    }

    .table-card tbody tr:hover {
        background-color: #f8fbff;
        border-left-color: #0d6efd;
        box-shadow: inset 0 0 8px rgba(13, 110, 253, 0.05);
    }

    .table-card .card-footer {
        background-color: #f8fbff;
        border-top: 1px solid #e7edf3;
        padding: 12px 16px;
        font-size: 0.85em;
        color: #6c757d;
    }

    /* ============================================
       KM CELL
       ============================================ */
    .km-cell {
        font-weight: bold;
        font-size: 1.1em;
        padding: 12px 8px;
        border-radius: 8px;
        text-align: center;
        transition: all 0.3s ease;
    }

    .km-normal {
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
        color: #155724;
        border: 2px solid #28a745;
        box-shadow: 0 2px 6px rgba(40, 167, 69, 0.15);
    }

    .km-warning {
        background: linear-gradient(135deg, #fff3cd, #ffe5a3);
        color: #856404;
        border: 2px solid #ffc107;
        box-shadow: 0 2px 6px rgba(255, 193, 7, 0.15);
    }

    .km-urgent {
        background: linear-gradient(135deg, #f8d7da, #f5c2c7);
        color: #721c24;
        border: 2px solid #dc3545;
        box-shadow: 0 2px 6px rgba(220, 53, 69, 0.15);
    }

    .km-overdue {
        background: linear-gradient(135deg, #e2e3e5, #d3d4d6);
        color: #383d41;
        border: 2px solid #6c757d;
        box-shadow: 0 2px 6px rgba(108, 117, 125, 0.15);
    }

    /* ============================================
       DURUM CELL (STATUS CELL)
       ============================================ */
    .status-cell {
        font-weight: bold;
        font-size: 1em;
        padding: 12px 8px !important;
        border-radius: 8px;
        text-align: center;
        transition: all 0.3s ease;
        display: inline-block !important;
        border: 2px solid rgba(0, 0, 0, 0.15) !important;
        color: white !important;
    }

    /* ============================================
       BADGE STILLERI
       ============================================ */
    .status-badge {
        font-size: 0.9em;
        padding: 6px 12px;
        border-radius: 6px;
        display: inline-block;
        font-weight: 500;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(0, 0, 0, 0.08);
    }

    /* ============================================
       ARA√á DURUMU TABLOSU
       ============================================ */
    #maintenanceTable {
        font-size: 1.1em !important;
    }

    #maintenanceTable thead th {
        font-size: 1.1em;
        padding: 14px 8px !important;
        color: #fff !important;
        font-weight: 600 !important;
        vertical-align: middle;
        background: linear-gradient(135deg, #1a2332 0%, #2c3e50 100%) !important;
        border-bottom: 3px solid #0d6efd !important;
    }

    #maintenanceTable tbody td {
        padding: 12px 8px !important;
        vertical-align: middle;
        font-size: 1.1em;
    }

    /* ============================================
       BAKI≈û PLANLAMASI TABLOSU
       ============================================ */
    .maintenance-schedule-table {
        font-size: 1.1em;
    }

    .maintenance-schedule-table thead th {
        font-size: 1.1em;
        padding: 14px 8px !important;
        color: #fff !important;
        font-weight: 600 !important;
        vertical-align: middle;
        background: linear-gradient(135deg, #1a2332 0%, #2c3e50 100%) !important;
        border-bottom: 3px solid #0d6efd !important;
    }

    .maintenance-schedule-table tbody td {
        padding: 12px 8px;
        vertical-align: middle;
        font-size: 1.1em;
    }

    .schedule-scope-urgent {
        background-color: #fff5f5;
        border-left: 4px solid #dc3545;
    }

    .schedule-scope-heavy {
        background-color: #fffbf0;
        border-left: 4px solid #ffc107;
    }

    .schedule-scope-normal {
        background-color: #f0f9ff;
        border-left: 4px solid #0d6efd;
    }

    .badge-scope-urgent {
        background-color: #dc3545;
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2);
    }

    .badge-scope-heavy {
        background-color: #ffc107;
        color: #000;
        box-shadow: 0 2px 4px rgba(255, 193, 7, 0.2);
    }

    .badge-scope-normal {
        background-color: #0d6efd;
        box-shadow: 0 2px 4px rgba(13, 110, 253, 0.2);
    }

    .schedule-km {
        font-weight: 600;
        font-size: 1.05em;
        min-width: 80px;
        color: #1a2332;
    }

    /* Sticky Table Headers */
    .sticky-top {
        position: sticky !important;
        top: 0 !important;
        z-index: 10 !important;
    }

    thead.table-dark.sticky-top {
        background: linear-gradient(135deg, #1a2332 0%, #2c3e50 100%) !important;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        border-bottom: 3px solid #0d6efd;
    }

    thead.table-dark.sticky-top th {
        color: #fff !important;
        font-weight: 600;
        border-color: #0d6efd;
    }

    .schedule-works {
        font-size: 0.85em;
        color: #666;
        line-height: 1.4;
    }

    .filter-btn-schedule {
        margin-bottom: 1rem;
    }

    #scheduleTable tbody tr {
        cursor: pointer;
        transition: all 0.2s ease;
    }

    #scheduleTable tbody tr:hover {
        box-shadow: inset 3px 0 0 #0d6efd;
        background-color: rgba(13, 110, 253, 0.03);
    }

    /* ============================================
       MODAL VE UYARI
       ============================================ */
    .modal-body .list-group-item {
        border-left: 4px solid #dee2e6;
        padding: 12px 14px;
        margin-bottom: 8px;
        border-radius: 6px;
        background-color: #f8fbff;
        border-top: 1px solid #e7edf3;
        border-bottom: 1px solid #e7edf3;
        border-right: 1px solid #e7edf3;
    }

    .modal-body .list-group-item.urgent {
        border-left-color: #dc3545;
        background-color: #fff5f5;
    }

    .modal-body .list-group-item.warning {
        border-left-color: #ffc107;
        background-color: #fffbf0;
    }

    .alert {
        border-radius: 8px;
        border-left: 4px solid;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }

    .alert-info {
        border-left-color: #0d6efd;
    }

    /* ============================================
       TAB VE BUTONLAR
       ============================================ */
    .nav-tabs {
        border-bottom: 2px solid #e7edf3;
    }

    .nav-tabs .nav-link {
        color: #6c757d;
        border: none;
        border-bottom: 3px solid transparent;
        font-weight: 500;
        transition: all 0.2s ease;
        margin-bottom: -2px;
    }

    .nav-tabs .nav-link:hover {
        color: #0d6efd;
        border-bottom-color: #e7edf3;
    }

    .nav-tabs .nav-link.active {
        color: #0d6efd;
        background-color: transparent;
        border-bottom-color: #0d6efd;
        font-weight: 600;
    }

    .btn-outline-secondary {
        border-color: #dee2e6;
        color: #6c757d;
    }

    .btn-outline-secondary:hover {
        background-color: #f8fbff;
        border-color: #0d6efd;
        color: #0d6efd;
    }

    .btn-outline-secondary.active {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: white;
    }

    /* ============================================
       ADAPTIF TASARIM
       ============================================ */
    @media (max-width: 768px) {
        .page-title {
            font-size: 1.5em;
        }

        .stat-card {
            padding: 16px;
        }

        .stat-content h3 {
            font-size: 1.3em;
        }

        .table-card thead th {
            font-size: 0.85em;
            padding: 12px 8px;
        }

        .table-card tbody td {
            font-size: 0.85em;
            padding: 10px 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h1 class="page-title">
                        <i class="bi bi-tools me-2"></i>Bakƒ±m Planlamasƒ±
                    </h1>
                    <p class="page-subtitle">Ara√ß bakƒ±m durumunu y√∂netin ve planlayƒ±n</p>
                </div>
                <button class="btn btn-outline-primary" onclick="exportToExcel()">
                    <i class="bi bi-download me-2"></i>Rapor ƒ∞ndir
                </button>
            </div>

            <div class="alert alert-info alert-dismissible fade show">
                <i class="bi bi-info-circle me-2"></i>
                <strong>ƒ∞pucu:</strong> Ara√ßlarƒ±n satƒ±rƒ±na tƒ±klayƒ±n veya "Detaylar" butonunu kullanarak bakƒ±m durumunu
                g√ºncelleyin.
            </div>
        </div>
    </div>

    <!-- ƒ∞statistik Kartlarƒ± -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-md-3">
            <div class="stat-card">
                <div class="stat-icon primary">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="stat-content">
                    <h3 id="count-all">0</h3>
                    <p>Toplam Ara√ß</p>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-3">
            <div class="stat-card">
                <div class="stat-icon success">
                    <i class="bi bi-check2-all"></i>
                </div>
                <div class="stat-content">
                    <h3 id="count-normal">0</h3>
                    <p>Normal Durum</p>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-3">
            <div class="stat-card">
                <div class="stat-icon warning">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <div class="stat-content">
                    <h3 id="count-warning">0</h3>
                    <p>Uyarƒ± Gereken</p>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-3">
            <div class="stat-card">
                <div class="stat-icon danger">
                    <i class="bi bi-exclamation-octagon"></i>
                </div>
                <div class="stat-content">
                    <h3 id="count-urgent">0</h3>
                    <p>Acil Bakƒ±m</p>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB SE√áƒ∞Mƒ∞ -->
    <div class="row mb-3">
        <div class="col-12">
            <ul class="nav nav-tabs" id="bakimTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="ara√ß-status-tab" data-bs-toggle="tab"
                        data-bs-target="#ara√ß-status" type="button" role="tab" aria-controls="ara√ß-status"
                        aria-selected="true">
                        <i class="bi bi-bus-front me-2"></i>Ara√ß Durumu
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="bakim-tablosu-tab" data-bs-toggle="tab" data-bs-target="#bakim-tablosu"
                        type="button" role="tab" aria-controls="bakim-tablosu" aria-selected="false">
                        <i class="bi bi-table me-2"></i>Bakƒ±m Planƒ± Tablosu
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <div class="tab-content" id="bakimTabContent">
        <!-- TAB 1: Ara√ß Durumu -->
        <div class="tab-pane fade show active" id="ara√ß-status" role="tabpanel" aria-labelledby="ara√ß-status-tab">

            <!-- Filtreler -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-outline-secondary active" onclick="filterTable('all')">
                            <i class="bi bi-funnel me-2"></i>T√ºm√º
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="filterTable('urgent')">
                            <i class="bi bi-exclamation-octagon me-2"></i>Acil
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="filterTable('warning')">
                            <i class="bi bi-exclamation-triangle me-2"></i>Uyarƒ±
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="filterTable('normal')">
                            <i class="bi bi-check2 me-2"></i>Normal
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tablo -->
            <div class="card shadow-sm table-card">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="maintenanceTable">
                        <thead class="table-dark sticky-top" style="top: 0;">
                            <tr>
                                <th style="width: 140px;" class="text-center">
                                    <i class="bi bi-bus-front me-2"></i>Ara√ß
                                </th>
                                <th style="width: 140px;" class="text-center">
                                    <i class="bi bi-speedometer2 me-2"></i>KM
                                </th>
                                <th style="width: 130px;" class="text-center">
                                    <i class="bi bi-speedometer2 me-2"></i>Sonraki
                                </th>
                                <th style="width: 110px;" class="text-center">
                                    <i class="bi bi-subtract me-2"></i>Fark
                                </th>
                                <th style="width: 120px;" class="text-center">
                                    <i class="bi bi-info-circle me-2"></i>Durum
                                </th>
                                <th style="width: 110px;" class="text-center">
                                    <i class="bi bi-pencil me-2"></i>ƒ∞≈ülem
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tbody">
                            <!-- Dinamik olarak doldurulacak -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- /TAB 1: Ara√ß Durumu -->

        <!-- TAB 2: Bakƒ±m Planƒ± Tablosu -->
        <div class="tab-pane fade" id="bakim-tablosu" role="tabpanel" aria-labelledby="bakim-tablosu-tab">
            <div class="row mb-3">
                <div class="col-12">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="number" class="form-control" id="kmSearch"
                            placeholder="KM'ye g√∂re ara (√∂rn: 36000)" min="0" max="300000">
                        <button class="btn btn-outline-primary" onclick="searchScheduleByKm()">Ara</button>
                        <button class="btn btn-outline-secondary" onclick="clearScheduleSearch()">Temizle</button>
                    </div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-12">
                    <div class="btn-group w-100 filter-btn-schedule" role="group">
                        <button type="button" class="btn btn-outline-secondary active" onclick="filterSchedule('all')">
                            <i class="bi bi-funnel me-2"></i>T√ºm√º
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="filterSchedule('urgent')">
                            <i class="bi bi-exclamation-octagon me-2"></i>√áOK KAPSAMLI (30+ i≈ü)
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="filterSchedule('heavy')">
                            <i class="bi bi-exclamation-triangle me-2"></i>KAPSAMLI (20-29 i≈ü)
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="filterSchedule('normal')">
                            <i class="bi bi-info-circle me-2"></i>ORTA (10-19 i≈ü)
                        </button>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm table-card">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 maintenance-schedule-table" id="scheduleTable">
                        <thead class="table-dark sticky-top" style="top: 0;">
                            <tr>
                                <th style="width: 100px;" class="text-center">
                                    <i class="bi bi-speedometer2 me-2"></i>KM
                                </th>
                                <th>Yapƒ±lacak Bakƒ±mlar</th>
                                <th style="width: 120px;" class="text-center">
                                    <i class="bi bi-hammer me-2"></i>ƒ∞≈ü Sayƒ±sƒ±
                                </th>
                                <th style="width: 130px;" class="text-center">
                                    <i class="bi bi-info-circle me-2"></i>Kapsamƒ±
                                </th>
                            </tr>
                        </thead>
                        <tbody id="scheduleTableBody">
                            <!-- Dinamik olarak doldurulacak -->
                        </tbody>
                    </table>
                </div>
                <div class="card-footer text-center text-muted small">
                    <i class="bi bi-info-circle me-1"></i>
                    Tabloy satƒ±rƒ±na tƒ±klayarak bakƒ±m detaylarƒ±nƒ± g√∂rebilirsiniz
                </div>
            </div>
        </div>
        <!-- /TAB 2: Bakƒ±m Planƒ± Tablosu -->
    </div>
    <!-- /Tab Content -->
</div>

<!-- Bakƒ±m Detay Modal -->
<div class="modal fade" id="maintenanceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTramName">Tramvay XXX</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Ara√ß Bilgileri</h6>
                        <p><strong>Ara√ß ID:</strong> <span id="modalTramId"></span></p>
                        <p><strong>Mevcut KM:</strong> <span id="modalCurrentKm"></span></p>
                        <p><strong>Genel Durum:</strong> <span id="modalStatus"></span></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Bakƒ±m √ñzeti</h6>
                        <p><strong>Acil Bakƒ±mlar:</strong> <span class="badge bg-danger" id="modalUrgentCount">0</span>
                        </p>
                        <p><strong>Uyarƒ±lƒ± Bakƒ±mlar:</strong> <span class="badge bg-warning text-dark"
                                id="modalWarningCount">0</span></p>
                        <p><strong>Tamamlanan:</strong> <span class="badge bg-success" id="modalCompletedCount">0</span>
                        </p>
                    </div>
                </div>

                <hr>

                <h6>Bakƒ±m Seviyelerine G√∂re Durum</h6>
                <div id="maintenanceDetails" style="max-height: 400px; overflow-y: auto;">
                    <!-- Dinamik olarak doldurulacak -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                <button type="button" class="btn btn-primary" onclick="saveMaintenanceState()">Deƒüi≈üiklikleri
                    Kaydet</button>
            </div>
        </div>
    </div>
</div>

<script>
    let maintenanceData = null;
    let maintenanceState = {}; // {tram_id: {level: {completed: bool, works: []}}}
    let currentTramId = null;
    let currentFilter = 'all';
    let scheduleData = null;
    let scheduleFilter = 'all';

    // Sayfa y√ºklendiƒüinde veri √ßek
    document.addEventListener('DOMContentLoaded', function () {
        loadData();
        loadState();
        loadSchedule();
    });

    function loadState() {
        // localStorage'dan bakƒ±m tamamlanma durumunu y√ºkle
        try {
            const saved = localStorage.getItem('maintenanceState');
            if (saved) {
                maintenanceState = JSON.parse(saved);
            }
        } catch (e) {
            console.error('State y√ºklenirken hata:', e);
        }
    }

    function saveState() {
        // localStorage'a bakƒ±m durumunu kaydet
        localStorage.setItem('maintenanceState', JSON.stringify(maintenanceState));
    }

    function loadData() {
        fetch('/api/bakim-verileri')
            .then(r => r.json())
            .then(data => {
                maintenanceData = data;
                renderTable();
                updateCounts();
            })
            .catch(err => {
                console.error('Veri y√ºklenirken hata:', err);
                alert('Bakƒ±m verileri y√ºklenemedi');
            });
    }

    function renderTable() {
        if (!maintenanceData) return;

        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '';

        maintenanceData.tramps.forEach(tram => {
            const row = createTableRow(tram);
            tbody.appendChild(row);
        });

        if (currentFilter !== 'all') {
            filterTable(currentFilter);
        }
    }

    function createTableRow(tram) {
        const row = document.createElement('tr');
        const tram_id = tram.tram_id;

        // En yakƒ±n bakƒ±mƒ± kullan (API'dan zaten hesaplanmƒ±≈ü)
        const nearest = tram.nearest_maintenance;
        const closestStatus = nearest.status;
        const closestKmLeft = nearest.km_left;
        const nextKm = nearest.next_km;
        const level = nearest.level;

        row.className = `status-${closestStatus}`;
        row.setAttribute('data-status', closestStatus);

        const kmCellClass = `km-cell km-${closestStatus}`;

        row.innerHTML = `
            <td class="text-center">
                <span class="badge bg-primary" style="font-size: 1.15em; font-weight: 600; padding: 6px 12px;">
                    ${tram.tram_name}
                </span>
            </td>
            <td class="text-center">
                <div class="${kmCellClass}">
                    <strong>${tram.current_km.toLocaleString('tr-TR')}</strong> KM
                    <div style="font-size: 0.8em; font-weight: 600; margin-top: 4px; color: #333; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 4px;">
                        üìç Sonraki: <strong>${level}</strong>
                    </div>
                </div>
            </td>
            <td class="text-center">
                <span class="fw-bold" style="font-size: 1em;">
                    ${nextKm === Infinity ? '‚àû' : nextKm.toLocaleString('tr-TR')} KM
                </span>
            </td>
            <td class="text-center">
                <span class="badge ${getKmLeftBadgeClass(closestKmLeft)}" style="font-size: 0.9em; padding: 6px 10px;">
                    ${closestKmLeft === 0 ? '0 KM' : (closestKmLeft > 0 ? '+' : '') + closestKmLeft.toLocaleString('tr-TR')} KM
                </span>
            </td>
            <td class="text-center">
                <span class="status-badge ${getStatusBadgeClass(closestStatus)} status-cell" style="font-size: 1em;">
                    ${getStatusText(closestStatus)}
                </span>
            </td>
            <td class="text-center">
                <button class="btn btn-sm btn-primary" onclick="openMaintenanceModal('${tram_id}')" style="cursor: pointer; padding: 5px 10px; font-size: 0.9em;">
                    <i class="bi bi-pencil-square me-1"></i>Detaylar
                </button>
            </td>
        `;

        row.style.cursor = 'pointer';
        row.onclick = function () {
            openMaintenanceModal(tram_id);
        };

        return row;
    }

    function getKmLeftBadgeClass(kmLeft) {
        if (kmLeft <= 0) return 'bg-dark';
        else if (kmLeft <= 500) return 'bg-danger';
        else if (kmLeft <= 2000) return 'bg-warning text-dark';
        else return 'bg-success';
    }

    function getStatusText(status) {
        const texts = {
            'normal': 'Normal ‚úì',
            'warning': 'Uyarƒ± ‚ö†Ô∏è',
            'urgent': 'Acil üî¥',
            'overdue': 'Ge√ßmi≈ü ‚úò'
        };
        return texts[status] || status;
    }

    function getStatusBadgeClass(status) {
        const classes = {
            'normal': 'bg-success',
            'warning': 'bg-warning text-dark',
            'urgent': 'bg-danger',
            'overdue': 'bg-dark'
        };
        return classes[status] || 'bg-secondary';
    }

    function updateCounts() {
        const counts = {
            all: 0,
            normal: 0,
            warning: 0,
            urgent: 0
        };

        maintenanceData.tramps.forEach(tram => {
            counts.all++;
            const closestStatus = tram.nearest_maintenance.status;
            counts[closestStatus]++;
        });

        document.getElementById('count-all').textContent = counts.all;
        document.getElementById('count-normal').textContent = counts.normal;
        document.getElementById('count-warning').textContent = counts.warning;
        document.getElementById('count-urgent').textContent = counts.urgent;
    }

    function filterTable(filter) {
        currentFilter = filter;

        // D√ºƒümeleri g√ºncelle
        document.querySelectorAll('.btn-group button').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        // Satƒ±rlarƒ± filtrele
        document.querySelectorAll('#tbody tr').forEach(row => {
            if (filter === 'all') {
                row.style.display = '';
            } else {
                const status = row.getAttribute('data-status');
                row.style.display = status === filter ? '' : 'none';
            }
        });
    }

    function openMaintenanceModal(tramId) {
        currentTramId = tramId;
        const tram = maintenanceData.tramps.find(t => t.tram_id === tramId);

        if (!tram) return;

        // Ba≈ülƒ±k ve bilgiler
        document.getElementById('modalTramName').textContent = tram.tram_name;
        document.getElementById('modalTramId').textContent = tramId;
        document.getElementById('modalCurrentKm').textContent = tram.current_km.toLocaleString('tr-TR') + ' KM';

        // Durum √∂zeti
        let urgentCount = 0, warningCount = 0;

        // ƒ∞nitialize tram state if not exists
        if (!maintenanceState[tramId]) {
            maintenanceState[tramId] = {};
        }

        // Bakƒ±m detaylarƒ± - t√ºm bakƒ±mlarƒ± g√∂ster
        const detailsDiv = document.getElementById('maintenanceDetails');
        detailsDiv.innerHTML = '';

        for (const level in tram.all_maintenances) {
            const maint = tram.all_maintenances[level];
            const levelDiv = createMaintenanceLevel(tramId, level, maint);
            detailsDiv.appendChild(levelDiv);

            // Duruma g√∂re say
            if (maint.status === 'urgent') urgentCount++;
            if (maint.status === 'warning') warningCount++;
        }

        document.getElementById('modalUrgentCount').textContent = urgentCount;
        document.getElementById('modalWarningCount').textContent = warningCount;

        // Genel durum
        const overallStatus = urgentCount > 0 ? 'Acil Bakƒ±m Gereklidir' :
            warningCount > 0 ? 'Uyarƒ±lƒ±' : 'Normal';
        document.getElementById('modalStatus').innerHTML = `<span class="badge ${urgentCount > 0 ? 'bg-danger' : warningCount > 0 ? 'bg-warning text-dark' : 'bg-success'
            }">${overallStatus}</span>`;

        // Modal a√ß
        const modal = new bootstrap.Modal(document.getElementById('maintenanceModal'));
        modal.show();
    }

    function createMaintenanceLevel(tramId, level, maint) {
        const div = document.createElement('div');
        const statusClass = maint.status === 'urgent' ? 'urgent' : maint.status === 'warning' ? 'warning' : '';

        div.className = `list-group-item ${statusClass}`;

        const isCompleted = maintenanceState[tramId] && maintenanceState[tramId][level] && maintenanceState[tramId][level].completed;

        div.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center">
                        <h6 class="mb-0">${level} Bakƒ±mƒ±</h6>
                        <span class="badge bg-info ms-2">${parseInt(level) * 1000} KM</span>
                        <span class="badge ${getStatusBadgeClass(maint.status)} ms-2">
                            ${getStatusText(maint.status)}
                        </span>
                    </div>
                    <div class="next-maintenance-box">
                        <small>
                            <strong>Sonraki Bakƒ±m:</strong> ${maint.next_km.toLocaleString('tr-TR')} KM 
                            (${maint.km_left.toLocaleString('tr-TR')} KM kaldƒ±)
                        </small>
                    </div>
                    <div>
                        <strong style="font-size: 0.9em;">ƒ∞≈üler:</strong>
                        <ul style="margin: 8px 0; padding-left: 20px; font-size: 0.85em;">
                            ${maint.works.map((w, idx) => `<li>${w}</li>`).join('')}
                        </ul>
                    </div>
                </div>
                <button class="btn btn-sm ${isCompleted ? 'btn-success' : 'btn-outline-success'}" 
                        onclick="toggleMaintenanceComplete('${tramId}', '${level}')">
                    ${isCompleted ? '‚úì Tamamlandƒ±' : 'Tamamla'}
                </button>
            </div>
        `;

        return div;
    }

    function toggleMaintenanceComplete(tramId, level) {
        if (!maintenanceState[tramId]) {
            maintenanceState[tramId] = {};
        }

        if (!maintenanceState[tramId][level]) {
            maintenanceState[tramId][level] = { completed: false, works: [] };
        }

        maintenanceState[tramId][level].completed = !maintenanceState[tramId][level].completed;
        saveState();

        // Modal'ƒ± yenile
        openMaintenanceModal(tramId);
    }

    function saveMaintenanceState() {
        saveState();

        // Modal'ƒ± kapat
        const modal = bootstrap.Modal.getInstance(document.getElementById('maintenanceModal'));
        modal.hide();

        // Tabloyu yenile
        renderTable();

        // Alert g√∂ster
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show';
        alert.innerHTML = `
            <i class="bi bi-check-circle me-2"></i>
            Bakƒ±m durumu kaydedildi
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.row').nextSibling);

        setTimeout(() => alert.remove(), 3000);
    }

    // BAKI≈û PLANLAMASI TABLOSU FONKSƒ∞YONLARI
    function loadSchedule() {
        fetch('/api/bakim-plani-tablosu')
            .then(r => r.json())
            .then(data => {
                scheduleData = data;
                renderScheduleTable();
            })
            .catch(err => {
                console.error('Schedule y√ºkleme hatasƒ±:', err);
                const tbody = document.getElementById('scheduleTableBody');
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Veri y√ºklenemedi</td></tr>`;
            });
    }

    function renderScheduleTable() {
        const tbody = document.getElementById('scheduleTableBody');
        tbody.innerHTML = '';

        if (!scheduleData || scheduleData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Veri bulunamadƒ±</td></tr>`;
            return;
        }

        scheduleData.forEach((item, index) => {
            if (scheduleFilter !== 'all' && item.scope !== scheduleFilter) {
                return;
            }

            const row = document.createElement('tr');
            row.className = `schedule-scope-${item.scope}`;
            row.style.cursor = 'pointer';

            const scopeBadgeClass = `badge-scope-${item.scope}`;
            const maintenanceList = item.maintenances.join(' + ');

            row.innerHTML = `
                <td class="schedule-km text-center">${item.km.toLocaleString()} <small class="text-muted d-block">KM</small></td>
                <td>
                    <div class="schedule-works">${maintenanceList}</div>
                </td>
                <td class="text-center">
                    <strong>${item.total_works}</strong>
                    <small class="d-block text-muted">i≈ü</small>
                </td>
                <td class="text-center">
                    <span class="badge ${scopeBadgeClass}">${item.scope_label}</span>
                </td>
            `;

            row.addEventListener('click', () => showScheduleDetail(item));
            tbody.appendChild(row);
        });
    }

    function filterSchedule(filter) {
        scheduleFilter = filter;
        renderScheduleTable();

        // Button aktifliƒüini g√ºncelle
        document.querySelectorAll('.filter-btn-schedule .btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
    }

    function searchScheduleByKm() {
        const kmValue = parseInt(document.getElementById('kmSearch').value);
        if (isNaN(kmValue) || kmValue < 0) {
            alert('L√ºtfen ge√ßerli bir KM deƒüeri girin');
            return;
        }

        const item = scheduleData.find(s => s.km === kmValue);
        if (!item) {
            alert(`${kmValue} KM'de bakƒ±m bulunmadƒ±`);
            return;
        }

        showScheduleDetail(item);
    }

    function clearScheduleSearch() {
        document.getElementById('kmSearch').value = '';
        scheduleFilter = 'all';
        renderScheduleTable();
    }

    function showScheduleDetail(item) {
        const details = item.maintenance_detail.map(m =>
            `<li class="list-group-item">
                <strong>${m.level}</strong> (${m.km.toLocaleString()} KM √ó ${m.ratio})<br>
                <small class="text-muted">${m.works} adet i≈ü</small>
            </li>`
        ).join('');

        const modalHtml = `
            <div class="modal fade" id="scheduleModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-info-circle me-2"></i>${item.km.toLocaleString()} KM Bakƒ±mƒ±
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <strong>Toplam ƒ∞≈ü:</strong> ${item.total_works} adet
                                <br>
                                <strong>Kapsamƒ±:</strong> <span class="badge badge-scope-${item.scope}">${item.scope_label}</span>
                            </div>
                            <h6>Yapƒ±lacak Bakƒ±mlar:</h6>
                            <ul class="list-group">
                                ${details}
                            </ul>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Eski modal varsa kaldƒ±r
        const oldModal = document.getElementById('scheduleModal');
        if (oldModal) oldModal.remove();

        // Yeni modal ekle
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Modal g√∂ster
        const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
        modal.show();
    }

    function exportToExcel() {
        alert('Excel raporu indirme √∂zelliƒüi yakƒ±nda eklenecektir');
    }
</script>

{% endblock %}